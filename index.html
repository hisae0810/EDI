<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²©å£²çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - TMå“å·®é¡å¯¾ç­–</title>
    <!-- SheetJS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆExcelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç”¨ï¼‰ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .filters {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
        }
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
            transition: border-color 0.3s;
        }
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            padding: 0 25px 15px 25px;
            background: #f8f9fa;
        }
        .view-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .stat-card h3 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .stat-card .sub-value {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }
        .stat-card.plan-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        .stat-card.plan-card::before {
            background: linear-gradient(90deg, #2196F3 0%, #1976D2 100%);
        }
        .stat-card.plan-card .value {
            color: #1565C0;
        }
        .stat-card.sales-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }
        .stat-card.sales-card::before {
            background: linear-gradient(90deg, #9C27B0 0%, #7B1FA2 100%);
        }
        .stat-card.sales-card .value {
            color: #6A1B9A;
        }
        .stat-card.sales-card.excellent {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        .stat-card.sales-card.excellent::before {
            background: linear-gradient(90deg, #4CAF50 0%, #388E3C 100%);
        }
        .stat-card.sales-card.excellent .value {
            color: #2E7D32;
        }
        .stat-card.sales-card.excellent .achievement-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
            animation: bounce 1s ease-in-out infinite;
        }
        .stat-card.sales-card.good {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
        }
        .stat-card.sales-card.good::before {
            background: linear-gradient(90deg, #FFC107 0%, #FFA000 100%);
        }
        .stat-card.sales-card.good .value {
            color: #F57F17;
        }
        .stat-card.sales-card.low {
            background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%);
        }
        .stat-card.sales-card.low::before {
            background: linear-gradient(90deg, #FF5722 0%, #E64A19 100%);
        }
        .stat-card.sales-card.low .value {
            color: #D84315;
        }
        .stat-card.deals-card {
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
        }
        .stat-card.deals-card::before {
            background: linear-gradient(90deg, #009688 0%, #00796B 100%);
        }
        .stat-card.deals-card .value {
            color: #00695C;
        }
        .stat-card.required-plan-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }
        .stat-card.required-plan-card::before {
            background: linear-gradient(90deg, #FF9800 0%, #F57C00 100%);
        }
        .stat-card.required-plan-card .value {
            color: #E65100;
        }
        .stat-card.required-target-card {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
        }
        .stat-card.required-target-card::before {
            background: linear-gradient(90deg, #E91E63 0%, #C2185B 100%);
        }
        .stat-card.required-target-card .value {
            color: #AD1457;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }
        .table-container {
            padding: 25px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            font-size: 11px;
        }
        tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        tbody tr.dept-row {
            background-color: #e3f2fd;
            font-weight: 700;
            font-size: 13px;
        }
        tbody tr.dept-row:hover {
            background-color: #bbdefb;
        }
        td {
            padding: 10px 8px;
        }
        .progress-bar {
            width: 100%;
            height: 18px;
            background: #e9ecef;
            border-radius: 9px;
            overflow: hidden;
            position: relative;
            min-width: 80px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .progress-fill.excellent {
            background: linear-gradient(90deg, #4CAF50 0%, #66BB6A 100%);
        }
        .progress-fill.good {
            background: linear-gradient(90deg, #FFC107 0%, #FFD54F 100%);
        }
        .progress-fill.low {
            background: linear-gradient(90deg, #FF5722 0%, #FF7043 100%);
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            min-width: 50px;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .search-info {
            padding: 15px 25px;
            background: #e7f3ff;
            border-left: 4px solid #2a5298;
            color: #004085;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .reset-btn {
            padding: 6px 12px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .reset-btn:hover {
            transform: scale(1.05);
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            display: none;
        }
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #loading .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        #loading .loading-spinner {
            font-size: 24px;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            .filters {
                flex-direction: column;
                padding: 15px;
            }
            .filter-group {
                width: 100%;
            }
            .filter-group select,
            .filter-group input {
                width: 100%;
                min-width: auto;
            }
            .view-toggle {
                flex-wrap: wrap;
                padding: 0 15px 15px 15px;
            }
            .view-btn {
                flex: 1;
                min-width: 100px;
            }
            .table-container {
                font-size: 10px;
                padding: 15px;
            }
            th, td {
                padding: 6px 4px;
            }
            .header h1 {
                font-size: 20px;
            }
            .header p {
                font-size: 12px;
            }
            .stat-card .value {
                font-size: 28px;
            }
            .search-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-content">
            <div class="loading-spinner">â³</div>
            <div>ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š TMå“è²©å£²çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>å–¶æ¥­éƒ¨åˆ¥ãƒ»å–¶æ¥­æ‰€åˆ¥ãƒ»æ©Ÿç¨®åˆ¥ãƒ»å€‹äººåˆ¥ã®è¨ˆç”»é”æˆçŠ¶æ³åˆ†æ</p>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="filters">
            <div class="filter-group">
                <label for="departmentFilter">å–¶æ¥­éƒ¨</label>
                <select id="departmentFilter" aria-label="å–¶æ¥­éƒ¨ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°">
                    <option value="">å…¨å–¶æ¥­éƒ¨</option>
                    <option value="ç—…é™¢å–¶æ¥­éƒ¨">ç—…é™¢å–¶æ¥­éƒ¨</option>
                    <option value="åŒ»ç™‚åœå–¶æ¥­éƒ¨">åŒ»ç™‚åœå–¶æ¥­éƒ¨</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="officeFilter">å–¶æ¥­æ‰€</label>
                <select id="officeFilter" aria-label="å–¶æ¥­æ‰€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°">
                    <option value="">å…¨å–¶æ¥­æ‰€</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="salesPersonFilter">å–¶æ¥­å“¡</label>
                <select id="salesPersonFilter" aria-label="å–¶æ¥­å“¡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°">
                    <option value="">å…¨å–¶æ¥­å“¡</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="productFilter">æ©Ÿç¨®</label>
                <select id="productFilter" aria-label="æ©Ÿç¨®ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°">
                    <option value="">å…¨æ©Ÿç¨®</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchInput">æ¤œç´¢</label>
                <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..." aria-label="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
            </div>
        </div>
        <div class="view-toggle">
            <button class="view-btn active" data-view="office">å–¶æ¥­æ‰€åˆ¥</button>
            <button class="view-btn" data-view="product">æ©Ÿç¨®åˆ¥</button>
            <button class="view-btn" data-view="detail">å€‹äººåˆ¥è©³ç´°</button>
        </div>
        <div class="stats-grid">
            <div class="stat-card plan-card">
                <h3>ğŸ“ˆ è¨ˆç”»å°æ•°åˆè¨ˆ</h3>
                <div class="value" id="totalPlan">0</div>
                <div class="sub-value">å°</div>
            </div>
            <div class="stat-card sales-card" id="salesCard">
                <h3>âœ… è²©å£²å®Ÿç¸¾åˆè¨ˆ</h3>
                <div class="value" id="totalSales">0</div>
                <div class="sub-value">è¨ˆç”»é”æˆç‡: <span id="achievementRate">0%</span><span class="achievement-badge" id="achievementBadge" style="display:none;">é”æˆ!</span></div>
            </div>
            <div class="stat-card deals-card">
                <h3>ğŸ’¼ ä¿æœ‰å•†è«‡åˆè¨ˆ</h3>
                <div class="value" id="totalDeals">0</div>
                <div class="sub-value">å°</div>
            </div>
            <div class="stat-card required-plan-card">
                <h3>ğŸ¯ è¨ˆç”»é”æˆå¿…è¦å•†è«‡</h3>
                <div class="value" id="requiredDealsForPlan">0</div>
                <div class="sub-value">å°</div>
            </div>
            <div class="stat-card required-target-card">
                <h3>ğŸš€ ç›®æ¨™é”æˆå¿…è¦å•†è«‡</h3>
                <div class="value" id="requiredDealsForTarget">0</div>
                <div class="sub-value">å°</div>
            </div>
        </div>
        <div class="search-info">
            <div>
                <strong>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</strong> <span id="viewMode">å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ(å–¶æ¥­éƒ¨åˆ¥å«ã‚€)</span> |
                è¡¨ç¤ºä¸­: <strong id="displayCount">0</strong>ä»¶ |
                <span id="lastUpdate" style="color: #666; font-size: 12px;">æœ€çµ‚æ›´æ–°: æœªå–å¾—</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;">
                <button class="reset-btn" onclick="document.getElementById('excelFileInput').click()" style="background: #007bff;">
                    ğŸ“ Excel/CSVèª­ã¿è¾¼ã¿
                </button>
                <button class="reset-btn" onclick="refreshData()" style="background: #28a745;">
                    ğŸ”„ GitHubæ›´æ–°
                </button>
                <button class="reset-btn" onclick="resetFilters()" style="background: #dc3545;">
                    ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead id="tableHeader"></thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
    <script>
        // ===== è¨­å®š =====
        const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/hisae0810/tm-sagaku-dashboard/main/sales_data.csv';
        
        // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const salesPersonMaster = [
            'æ¨ªå±± é™½ä¸‰', 'å¯Œç”° å“ä¹Ÿ', 'åƒç”° é•·æ²»', 'ç¨²è‘‰ æ™¶æ•™', 'æ£®å±± å­¦',
            'è›¯åŸ æ¸©', 'ä¸‰è¼ª é›„å¤§', 'ç­’äº• æ¥“', 'æµœé‡ éš†è¡Œ', 'æ±Ÿæ³¢ ç¿”',
            'ä½ã€…æœ¨ ç¥æ–—', 'ç¥åŸ ç¾ç–', 'ç™½æ‰ åŸå¤ª', 'è—¤åŸ åœ­ä»‹', 'æ¢ç€¬ å…‰å¤ªéƒ',
            'äº•æ‰‹ æ™ºä¹Ÿ', 'æ¾æœ¬ æ™´ç™»', 'æ¸‹è°· å´‡', 'ä¿é‡Œ å‹ä½‘', 'åŒ—æ¾¤ ç”²æ–',
            'çŒ¿å· é›„å¤ª', 'ä¸­æ›½æ ¹ åŠŸä¹Ÿ', 'çŸ³å· å¹¸ç”·', 'æ— è–å¤ª', 'æ±Ÿè‰ äº˜',
            'é½Šè—¤ é›…æ¨¹', 'çŸ³äº• åšä¹‹', 'æ‰æœ¬ é€²ä»‹', 'æ¾ç”° æ‹“ä¹Ÿ', 'ä½ã€…æœ¨ è‰¯ä»‹',
            'é«™æ©‹ å‡Œ', 'é•·æ¸¡ ç›´æ¨¹', 'å±±æœ¬ é”ä¹Ÿ', 'çŸ³å· é›„æ¨¹', 'è±Šç”° æ‚ å¤ª',
            'å¿—ç”° å‹åˆ©', 'é£¯æ²¼ éš¼å¹³', 'ç¹”åŸ å¥', 'åŠ è—¤ å“²æœ—', 'åƒè‘‰ å¤§è²´',
            'ç¬¹é–“ é›„è²´'
        ];
        
        const productMaster = [
            'CSM', 'BSM', 'PVM', 'SVM', 'CNS', 'WEP', 'é€ä¿¡æ©Ÿ',
            'TEC-8/5', 'EMS', 'HAMILTON', 'NKV-NPPV', 'å¿ƒé›»è¨ˆ',
            'DSC,QP', 'ãƒ›ãƒ«ã‚¿ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ€', 'STS', 'RMC', 'EEG',
            'MEB/MEE', 'MEK', 'CHM'
        ];
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let rawData = [];
        let allData = [];
        let currentView = 'office';
        let filteredData = [];
        
        // ===== CSVèª­ã¿è¾¼ã¿æ©Ÿèƒ½ =====
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            console.log('CSVãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) {
                    console.warn('è¡Œ' + (i + 1) + 'ã®ã‚«ãƒ©ãƒ æ•°ãŒä¸æ­£ã§ã™:', values);
                    continue;
                }
                
                const row = {};
                headers.forEach((header, index) => {
                    const value = values[index].trim();
                    if (['plan', 'sales', 'deals', 'target'].includes(header)) {
                        row[header] = parseFloat(value) || 0;
                    } else {
                        row[header] = value;
                    }
                });
                data.push(row);
            }
            
            console.log('CSVãƒ‡ãƒ¼ã‚¿è§£æå®Œäº†: ' + data.length + 'ä»¶');
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        async function loadCSVFromGitHub() {
            try {
                showLoading(true);
                const timestamp = new Date().getTime();
                const url = GITHUB_CSV_URL + '?t=' + timestamp;
                console.log('CSVèª­ã¿è¾¼ã¿é–‹å§‹:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/csv,text/plain',
                    },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error('HTTPã‚¨ãƒ©ãƒ¼: ' + response.status + ' ' + response.statusText);
                }
                
                const csvText = await response.text();
                console.log('CSVå–å¾—æˆåŠŸ:', csvText.length, 'æ–‡å­—');
                
                const data = parseCSV(csvText);
                return data;
            } catch (error) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                return null;
            } finally {
                showLoading(false);
            }
        }
        
        // ===== Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ =====
        document.getElementById('excelFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                showLoading(true);
                let data;
                
                if (file.name.endsWith('.csv')) {
                    data = await readCSVFile(file);
                } else {
                    data = await readExcelFile(file);
                }
                
                if (data && data.length > 0) {
                    rawData.length = 0;
                    rawData.push(...data);
                    allData.length = 0;
                    allData.push(...validateAndCleanData());
                    filteredData = [...allData];
                    updateDisplay();
                    
                    const now = new Date().toLocaleString('ja-JP');
                    document.getElementById('lastUpdate').textContent = 'æœ€çµ‚æ›´æ–°: ' + now;
                    document.getElementById('lastUpdate').style.color = '#28a745';
                    alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\næ›´æ–°æ™‚åˆ»: ' + now + '\nä»¶æ•°: ' + data.length + 'ä»¶');
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
                e.target.value = '';
            }
        });
        
        async function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const data = parseCSV(csvText);
                        console.log('CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ:', data.length, 'ä»¶');
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        console.log('Excelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ:', jsonData.length, 'ä»¶');
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // ===== ãƒ‡ãƒ¼ã‚¿æ›´æ–° =====
        async function refreshData() {
            const loadedData = await loadCSVFromGitHub();
            
            if (loadedData && loadedData.length > 0) {
                const validData = loadedData.filter(item => {
                    if (!item.dept || !item.office || !item.person || !item.product) {
                        console.warn('ä¸å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—:', item);
                        return false;
                    }
                    return true;
                });
                
                console.log('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿: ' + validData.length + '/' + loadedData.length + 'ä»¶');
                
                rawData.length = 0;
                rawData.push(...validData);
                allData.length = 0
                allData.push(...validateAndCleanData());
                filteredData = [...allData];
                updateDisplay();
                
                const now = new Date().toLocaleString('ja-JP');
                const lastUpdateElement = document.getElementById('lastUpdate');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = 'æœ€çµ‚æ›´æ–°: ' + now;
                    lastUpdateElement.style.color = '#28a745';
                }
                alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼\næ›´æ–°æ™‚åˆ»: ' + now + '\nä»¶æ•°: ' + validData.length + 'ä»¶');
            } else {
                showError('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }
        
        function validateAndCleanData() {
            return rawData.filter(item => {
                if (!item.dept || !item.office || !item.person || !item.product) {
                    console.warn('ä¸å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿:', item);
                    return false;
                }
                item.plan = Number(item.plan) || 0;
                item.sales = Number(item.sales) || 0;
                item.deals = Number(item.deals) || 0;
                item.target = Number(item.target) || 0;
                return true;
            });
        }
        
        // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ =====
        function initFilters() {
            try {
                const offices = [...new Set(allData.map(d => d.office))].sort();
                const officeFilter = document.getElementById('officeFilter');
                const salesPersonFilter = document.getElementById('salesPersonFilter');
                const productFilter = document.getElementById('productFilter');
                
                officeFilter.innerHTML = '<option value="">å…¨å–¶æ¥­æ‰€</option>';
                offices.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office;
                    option.textContent = office;
                    officeFilter.appendChild(option);
                });
                
                salesPersonFilter.innerHTML = '<option value="">å…¨å–¶æ¥­å“¡</option>';
                salesPersonMaster.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    salesPersonFilter.appendChild(option);
                });
                
                productFilter.innerHTML = '<option value="">å…¨æ©Ÿç¨®</option>';
                productMaster.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productFilter.appendChild(option);
                });
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        function filterData() {
            try {
                const deptValue = document.getElementById('departmentFilter').value;
                const officeValue = document.getElementById('officeFilter').value;
                const personValue = document.getElementById('salesPersonFilter').value;
                const productValue = document.getElementById('productFilter').value;
                const searchValue = document.getElementById('searchInput').value.toLowerCase();
                
                if (!deptValue && !officeValue && !personValue && !productValue && !searchValue) {
                    filteredData = [...allData];
                } else {
                    filteredData = allData.filter(item => {
                        if (deptValue && item.dept !== deptValue) return false;
                        if (officeValue && item.office !== officeValue) return false;
                        if (personValue && item.person !== personValue) return false;
                        if (productValue && item.product !== productValue) return false;
                        if (searchValue) {
                            const searchableText = (item.office + ' ' + item.person + ' ' + item.product).toLowerCase();
                            if (!searchableText.includes(searchValue)) return false;
                        }
                        return true;
                    });
                }
                
                if (personValue || (officeValue && productValue)) {
                    currentView = 'detail';
                    updateViewButtons();
                }
                
                updateDisplay();
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        function resetFilters() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('officeFilter').value = '';
            document.getElementById('salesPersonFilter').value = '';
            document.getElementById('productFilter').value = '';
            document.getElementById('searchInput').value = '';
            currentView = 'office';
            updateViewButtons();
            filterData();
        }
        
        // ===== çµ±è¨ˆæ›´æ–° =====
        function updateStats() {
            try {
                const totalPlan = filteredData.reduce((sum, item) => sum + (item.plan || 0), 0);
                const totalSales = filteredData.reduce((sum, item) => sum + (item.sales || 0), 0);
                const totalDeals = filteredData.reduce((sum, item) => sum + (item.deals || 0), 0);
                
                const requiredForPlan = filteredData.reduce((sum, item) => {
                    const remaining = (item.plan || 0) - (item.sales || 0);
                    return sum + Math.max(0, remaining - (item.deals || 0));
                }, 0);
                
                const requiredForTarget = filteredData.reduce((sum, item) => {
                    const remaining = (item.target || 0) - (item.sales || 0);
                    return sum + Math.max(0, remaining - (item.deals || 0));
                }, 0);
                
                const achievementRate = totalPlan > 0 ? ((totalSales / totalPlan) * 100).toFixed(1) : 0;
                
                document.getElementById('totalPlan').textContent = totalPlan.toFixed(1);
                document.getElementById('totalSales').textContent = totalSales.toFixed(1);
                document.getElementById('totalDeals').textContent = totalDeals.toFixed(1);
                document.getElementById('requiredDealsForPlan').textContent = requiredForPlan.toFixed(1);
                document.getElementById('requiredDealsForTarget').textContent = requiredForTarget.toFixed(1);
                document.getElementById('achievementRate').textContent = achievementRate + '%';
                
                const salesCard = document.getElementById('salesCard');
                const achievementBadge = document.getElementById('achievementBadge');
                salesCard.classList.remove('excellent', 'good', 'low');
                
                if (achievementRate >= 100) {
                    salesCard.classList.add('excellent');
                    achievementBadge.style.display = 'inline-block';
                    achievementBadge.textContent = 'ğŸ‰ é”æˆ!';
                } else if (achievementRate >= 80) {
                    salesCard.classList.add('good');
                    achievementBadge.style.display = 'none';
                } else {
                    salesCard.classList.add('low');
                    achievementBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showError('çµ±è¨ˆã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ===== é›†è¨ˆé–¢æ•° =====
        function aggregateByDept() {
            const deptMap = new Map();
            filteredData.forEach(item => {
                if (!deptMap.has(item.dept)) {
                    deptMap.set(item.dept, {
                        dept: item.dept,
                        plan: 0,
                        sales: 0,
                        deals: 0,
                        target: 0
                    });
                }
                const dept = deptMap.get(item.dept);
                dept.plan += item.plan || 0;
                dept.sales += item.sales || 0;
                dept.deals += item.deals || 0;
                dept.target += item.target || 0;
            });
            return Array.from(deptMap.values());
        }
        
        function aggregateByOffice() {
            const officeMap = new Map();
            filteredData.forEach(item => {
                if (!officeMap.has(item.office)) {
                    officeMap.set(item.office, {
                        dept: item.dept,
                        office: item.office,
                        plan: 0,
                        sales: 0,
                        deals: 0,
                        target: 0
                    });
                }
                const office = officeMap.get(item.office);
                office.plan += item.plan || 0;
                office.sales += item.sales || 0;
                office.deals += item.deals || 0;
                office.target += item.target || 0;
            });
            return Array.from(officeMap.values());
        }
        
        function aggregateByProduct() {
            const productMap = new Map();
            filteredData.forEach(item => {
                if (!productMap.has(item.product)) {
                    productMap.set(item.product, {
                        product: item.product,
                        plan: 0,
                        sales: 0,
                        deals: 0,
                        target: 0
                    });
                }
                const product = productMap.get(item.product);
                product.plan += item.plan || 0;
                product.sales += item.sales || 0;
                product.deals += item.deals || 0;
                product.target += item.target || 0;
            });
            
            const result = Array.from(productMap.values());
            result.sort((a, b) => {
                const indexA = productMaster.indexOf(a.product);
                const indexB = productMaster.indexOf(b.product);
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.product.localeCompare(b.product);
            });
            return result;
        }
        
        function isFilterApplied() {
            return document.getElementById('departmentFilter').value ||
                   document.getElementById('officeFilter').value ||
                   document.getElementById('salesPersonFilter').value ||
                   document.getElementById('productFilter').value ||
                   document.getElementById('searchInput').value;
        }
        
        // ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
        function renderRow(item, plan, sales, deals, target, totalWithDeals, achievementRate, requiredForPlan, requiredForTarget) {
            let progressClass = '';
            if (achievementRate >= 100) {
                progressClass = 'excellent';
            } else if (achievementRate >= 80) {
                progressClass = 'good';
            } else if (achievementRate < 50) {
                progressClass = 'low';
            }
            
            return '<td>' + plan.toFixed(1) + '</td>' +
                '<td><strong>' + sales.toFixed(1) + '</strong></td>' +
                '<td>' +
                    '<div class="progress-bar">' +
                        '<div class="progress-fill ' + progressClass + '" style="width: ' + Math.min(achievementRate, 100) + '%">' +
                            achievementRate + '%' +
                        '</div>' +
                    '</div>' +
                '</td>' +
                '<td>' + deals.toFixed(1) + '</td>' +
                '<td>' + totalWithDeals.toFixed(1) + '</td>' +
                '<td>' + target.toFixed(1) + '</td>' +
                '<td>' +
                    (requiredForPlan > 0 ?
                        '<span class="badge badge-danger">' + requiredForPlan.toFixed(1) + 'å°</span>' :
                        '<span class="badge badge-success">å……è¶³</span>') +
                '</td>' +
                '<td>' +
                    (requiredForTarget > 0 ?
                        '<span class="badge badge-info">' + requiredForTarget.toFixed(1) + 'å°</span>' :
                        '<span class="badge badge-success">å……è¶³</span>') +
                '</td>';
        }
        
        function updateTable() {
            try {
                const thead = document.getElementById('tableHeader');
                const tbody = document.getElementById('dataTable');
                tbody.innerHTML = '';
                
                let data, headers;
                const filterApplied = isFilterApplied();
                
                if (currentView === 'office') {
                    if (!filterApplied) {
                        headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>å–¶æ¥­æ‰€</th><th>è¨ˆç”»</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>ä¿æœ‰å•†è«‡</th><th>å®Ÿç¸¾+ä¿æœ‰</th><th>ç›®æ¨™å°æ•°</th><th>å¿…è¦å•†è«‡(è¨ˆç”»)</th><th>å¿…è¦å•†è«‡(ç›®æ¨™)</th></tr>';
                        document.getElementById('viewMode').textContent = 'å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ(å–¶æ¥­éƒ¨åˆ¥å«ã‚€)';
                        
                        const deptData = aggregateByDept();
                        const officeData = aggregateByOffice();
                        
                        const deptGroups = {};
                        officeData.forEach(office => {
                            if (!deptGroups[office.dept]) {
                                deptGroups[office.dept] = [];
                            }
                            deptGroups[office.dept].push(office);
                        });
                        
                        thead.innerHTML = headers;
                        
                        deptData.forEach(dept => {
                            const plan = dept.plan || 0;
                            const sales = dept.sales || 0;
                            const deals = dept.deals || 0;
                            const target = dept.target || 0;
                            const totalWithDeals = sales + deals;
                            const achievementRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                            const requiredForPlan = Math.max(0, plan - sales - deals);
                            const requiredForTarget = Math.max(0, target - sales - deals);
                            
                            const deptRow = document.createElement('tr');
                            deptRow.className = 'dept-row';
                            deptRow.innerHTML = '<td colspan="2"><strong>ã€' + dept.dept + 'ã€‘</strong></td>' +
                                renderRow(dept, plan, sales, deals, target, totalWithDeals, achievementRate, requiredForPlan, requiredForTarget);
                            tbody.appendChild(deptRow);
                            
                            if (deptGroups[dept.dept]) {
                                deptGroups[dept.dept].forEach(office => {
                                    const oPlan = office.plan || 0;
                                    const oSales = office.sales || 0;
                                    const oDeals = office.deals || 0;
                                    const oTarget = office.target || 0;
                                    const oTotalWithDeals = oSales + oDeals;
                                    const oAchievementRate = oPlan > 0 ? ((oSales / oPlan) * 100).toFixed(1) : 0;
                                    const oRequiredForPlan = Math.max(0, oPlan - oSales - oDeals);
                                    const oRequiredForTarget = Math.max(0, oTarget - oSales - oDeals);
                                    
                                    const officeRow = document.createElement('tr');
                                    officeRow.innerHTML = '<td style="padding-left: 20px;">' + office.dept + '</td>' +
                                        '<td><strong>' + office.office + '</strong></td>' +
                                        renderRow(office, oPlan, oSales, oDeals, oTarget, oTotalWithDeals, oAchievementRate, oRequiredForPlan, oRequiredForTarget);
                                    tbody.appendChild(officeRow);
                                });
                            }
                        });
                        
                        document.getElementById('displayCount').textContent = deptData.length + officeData.length;
                        return;
                    } else {
                        data = aggregateByOffice();
                        headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>å–¶æ¥­æ‰€</th><th>è¨ˆç”»</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>ä¿æœ‰å•†è«‡</th><th>å®Ÿç¸¾+ä¿æœ‰</th><th>ç›®æ¨™å°æ•°</th><th>å¿…è¦å•†è«‡(è¨ˆç”»)</th><th>å¿…è¦å•†è«‡(ç›®æ¨™)</th></tr>';
                        document.getElementById('viewMode').textContent = 'å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ';
                    }
                } else if (currentView === 'product') {
                    data = aggregateByProduct();
                    headers = '<tr><th>æ©Ÿç¨®</th><th>è¨ˆç”»</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>ä¿æœ‰å•†è«‡</th><th>å®Ÿç¸¾+ä¿æœ‰</th><th>ç›®æ¨™å°æ•°</th><th>å¿…è¦å•†è«‡(è¨ˆç”»)</th><th>å¿…è¦å•†è«‡(ç›®æ¨™)</th></tr>';
                    document.getElementById('viewMode').textContent = 'æ©Ÿç¨®åˆ¥é›†è¨ˆ';
                } else {
                    data = filteredData;
                    headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>å–¶æ¥­æ‰€</th><th>å–¶æ¥­å“¡</th><th>æ©Ÿç¨®</th><th>è¨ˆç”»</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>ä¿æœ‰å•†è«‡</th><th>å®Ÿç¸¾+ä¿æœ‰</th><th>ç›®æ¨™å°æ•°</th><th>å¿…è¦å•†è«‡(è¨ˆç”»)</th><th>å¿…è¦å•†è«‡(ç›®æ¨™)</th></tr>';
                    document.getElementById('viewMode').textContent = 'å€‹äººåˆ¥è©³ç´°';
                }
                
                thead.innerHTML = headers;
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    const plan = item.plan || 0;
                    const sales = item.sales || 0;
                    const deals = item.deals || 0;
                    const target = item.target || 0;
                    const totalWithDeals = sales + deals;
                    const achievementRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                    const requiredForPlan = Math.max(0, plan - sales - deals);
                    const requiredForTarget = Math.max(0, target - sales - deals);
                    
                    if (currentView === 'office') {
                        row.innerHTML = '<td><strong>' + item.dept + '</strong></td>' +
                            '<td><strong>' + item.office + '</strong></td>' +
                            renderRow(item, plan, sales, deals, target, totalWithDeals, achievementRate, requiredForPlan, requiredForTarget);
                    } else if (currentView === 'product') {
                        row.innerHTML = '<td><strong>' + item.product + '</strong></td>' +
                            renderRow(item, plan, sales, deals, target, totalWithDeals, achievementRate, requiredForPlan, requiredForTarget);
                    } else {
                        row.innerHTML = '<td>' + item.dept + '</td>' +
                            '<td>' + item.office + '</td>' +
                            '<td><strong>' + item.person + '</strong></td>' +
                            '<td><strong>' + item.product + '</strong></td>' +
                            renderRow(item, plan, sales, deals, target, totalWithDeals, achievementRate, requiredForPlan, requiredForTarget);
                    }
                    tbody.appendChild(row);
                });
                
                document.getElementById('displayCount').textContent = data.length;
            } catch (error) {
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        function updateDisplay() {
            showLoading(true);
            try {
                updateStats();
                updateTable();
            } finally {
                setTimeout(() => showLoading(false), 100);
            }
        }
        
        function updateViewButtons() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === currentView) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ =====
        document.getElementById('departmentFilter').addEventListener('change', filterData);
        document.getElementById('officeFilter').addEventListener('change', filterData);
        document.getElementById('salesPersonFilter').addEventListener('change', filterData);
        document.getElementById('productFilter').addEventListener('change', filterData);
        document.getElementById('searchInput').addEventListener('input', filterData);
        
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentView = btn.dataset.view;
                updateViewButtons();
                updateDisplay();
            });
        });
        
        // ===== åˆæœŸåŒ– =====
        async function initialize() {
            try {
                showLoading(true);
                console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
                
                const loadedData = await loadCSVFromGitHub();
                if (loadedData && loadedData.length > 0) {
                    rawData = loadedData;
                    console.log('GitHubã®CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                } else {
                    console.log('åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
                    showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHubã®URLã‚’ç¢ºèªã™ã‚‹ã‹ã€Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                }
                
                allData = validateAndCleanData();
                filteredData = [...allData];
                initFilters();
                updateDisplay();
                
                const lastUpdateElement = document.getElementById('lastUpdate');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleString('ja-JP');
                }
                
                console.log('åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                showLoading(false);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>