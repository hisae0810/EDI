<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIç‡ãƒ»ç›´è²©ç‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; }
        .refresh-btn { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .refresh-btn:hover { background: white; color: #667eea; transform: rotate(180deg); }
        .filter-section { background: #f8f9fa; padding: 20px 30px; border-bottom: 2px solid #e9ecef; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-label { font-weight: bold; color: #333; }
        .filter-select { padding: 10px 20px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; background: white; cursor: pointer; min-width: 180px; }
        .dashboard { padding: 30px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .kpi-card.warning { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); }
        .kpi-card.pink { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .kpi-card.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .kpi-label { font-size: 0.9em; opacity: 0.9; }
        .kpi-value { font-size: 2.5em; font-weight: bold; margin-top: 10px; }
        .chart-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 25px; }
        .chart-title { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; }
        .chart-description { font-size: 0.9em; color: #666; line-height: 1.6; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        tr:hover { background: #f8f9fa; }
        .up { color: #38ef7d; font-weight: bold; }
        .down { color: #f5576c; font-weight: bold; }
        .donut-container { position: relative; max-width: 400px; margin: 0 auto; }
        .corr-card { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 25px; }
        .corr-value { font-size: 3em; font-weight: bold; color: #333; }
        .corr-explanation { font-size: 0.9em; color: #333; margin-top: 15px; line-height: 1.6; text-align: left; background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; }
        .quadrant { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .quad-box { padding: 20px; border-radius: 10px; text-align: center; }
        .quad-1 { background: #e8f5e9; border: 2px solid #4caf50; }
        .quad-2 { background: #e3f2fd; border: 2px solid #2196f3; }
        .quad-3 { background: #fff3e0; border: 2px solid #ff9800; }
        .quad-4 { background: #ffebee; border: 2px solid #f44336; }
        .quad-title { font-weight: bold; margin-bottom: 5px; font-size: 1.1em; }
        .quad-subtitle { font-size: 0.85em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="refresh-btn" onclick="location.reload(true)">ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
            <h1>ğŸ“Š EDIç‡ãƒ»ç›´è²©ç‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>å—é–¢æ±æ”¯åº— - é›»å­ãƒ‡ãƒ¼ã‚¿äº¤æ›ã¨ç›´è²©ã®åˆ©ç”¨çŠ¶æ³ã‚’å¯è¦–åŒ–</p>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">ğŸ¢ éƒ¨é–€:</span>
                <select id="deptFilter" class="filter-select" onchange="applyFilter()">
                    <option value="all">ã™ã¹ã¦ã®éƒ¨é–€</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">ğŸ“ å–¶æ¥­æ‰€:</span>
                <select id="officeFilter" class="filter-select" onchange="applyFilter()">
                    <option value="all">ã™ã¹ã¦ã®å–¶æ¥­æ‰€</option>
                </select>
            </div>
        </div>

        <div class="dashboard">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">âœ… EDIä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="ediCount">0</span><span style="font-size:0.4em"> (<span id="ediRate">0</span>%)</span></div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-label">âš ï¸ æ‰‹å‹•ä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="manualCount">0</span><span style="font-size:0.4em"> (<span id="manualRate">0</span>%)</span></div>
                </div>
                <div class="kpi-card pink">
                    <div class="kpi-label">ğŸ¯ ç›´è²©ä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="directCount">0</span><span style="font-size:0.4em"> (<span id="directRate">0</span>%)</span></div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">ğŸ“¦ é–“æ¥è²©å£²ä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="indirectCount">0</span><span style="font-size:0.4em"> (<span id="indirectRate">0</span>%)</span></div>
                </div>
            </div>

            <div class="corr-card">
                <div class="chart-title">ğŸ“Š EDIç‡ã¨ç›´è²©ç‡ã®é–¢ä¿‚æ€§</div>
                <div class="corr-value" id="corrValue">-0.00</div>
                <div class="corr-explanation">
                    <strong>ğŸ“Œ ã“ã®æ•°å€¤ã®æ„å‘³ï¼š</strong><br>
                    <span id="corrText">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</span><br><br>
                    <strong>ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong><br>
                    â€¢ é–“æ¥è²©å£²ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼çµŒç”±ï¼‰ãŒå¤šã„å–¶æ¥­æ‰€ã¯ã€å–å¼•å…ˆãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®EDIå¯¾å¿œçŠ¶æ³ã«ã‚ˆã£ã¦EDIç‡ãŒæ±ºã¾ã‚Šã¾ã™<br>
                    â€¢ ç›´è²©ãŒå¤šã„å–¶æ¥­æ‰€ã¯æ‰‹å‹•å‡¦ç†ãŒå¢—ãˆã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™<br>
                    â€¢ EDIç‡ã‚’ä¸Šã’ã‚‹ã«ã¯ã€â‘ é–“æ¥è²©å£²ã¸ã®ç§»è¡Œã€â‘¡å–å¼•å…ˆã®EDIå°å…¥æ”¯æ´ã€ãŒé‡è¦ã§ã™
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">ğŸ¯ EDIç‡ vs ç›´è²©ç‡ï¼ˆæ•£å¸ƒå›³ï¼‰</div>
                    <div class="chart-description">
                        <strong>ğŸ“Š ã“ã®å›³ã®è¦‹æ–¹ï¼š</strong><br>
                        â€¢ <strong>å·¦ä¸Šï¼ˆç†æƒ³å‹ï¼‰</strong>: é–“æ¥è²©å£²ãŒå¤šãã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒEDIå¯¾å¿œæ¸ˆã¿<br>
                        â€¢ <strong>å·¦ä¸‹ï¼ˆEDIæ¨é€²ä½™åœ°ï¼‰</strong>: é–“æ¥è²©å£²ã¯å¤šã„ãŒã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒEDIæœªå¯¾å¿œ<br>
                        â€¢ <strong>å³ä¸‹ï¼ˆæœ€å„ªå…ˆæ”¹å–„ï¼‰</strong>: ç›´è²©ãŒå¤šãã€EDIã‚‚é€²ã‚“ã§ã„ãªã„
                    </div>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ—‚ï¸ å–¶æ¥­æ‰€åˆ†é¡ï¼ˆ4è±¡é™ï¼‰</div>
                    <div class="quadrant">
                        <div class="quad-box quad-1">
                            <div class="quad-title">ğŸŒŸ ç†æƒ³å‹</div>
                            <div class="quad-subtitle">EDIé«˜/ç›´è²©ä½</div>
                            <div style="font-size:0.85em;color:#2e7d32;margin-bottom:8px;">é–“æ¥è²©å£²å¤šãƒ»EDIå¯¾å¿œæ¸ˆ</div>
                            <div id="q1" style="margin-top:10px;font-size:0.85em;"></div>
                        </div>
                        <div class="quad-box quad-2">
                            <div class="quad-title">ğŸ’ª ãƒãƒ©ãƒ³ã‚¹å‹</div>
                            <div class="quad-subtitle">EDIé«˜/ç›´è²©é«˜</div>
                            <div style="font-size:0.85em;color:#1565c0;margin-bottom:8px;">ç›´è²©ã‚ã‚Šãƒ»EDIé€²ã‚“ã§ã„ã‚‹</div>
                            <div id="q2" style="margin-top:10px;font-size:0.85em;"></div>
                        </div>
                        <div class="quad-box quad-3">
                            <div class="quad-title">ğŸ“ˆ EDIæ¨é€²ä½™åœ°</div>
                            <div class="quad-subtitle">EDIä½/ç›´è²©ä½</div>
                            <div style="font-size:0.85em;color:#f57c00;margin-bottom:8px;">é–“æ¥è²©å£²å¤šãƒ»EDIæœªå¯¾å¿œ</div>
                            <div id="q3" style="margin-top:10px;font-size:0.85em;"></div>
                        </div>
                        <div class="quad-box quad-4">
                            <div class="quad-title">âš ï¸ æœ€å„ªå…ˆæ”¹å–„</div>
                            <div class="quad-subtitle">EDIä½/ç›´è²©é«˜</div>
                            <div style="font-size:0.85em;color:#c62828;margin-bottom:8px;">ç›´è²©å¤šãƒ»EDIæœªå¯¾å¿œ</div>
                            <div id="q4" style="margin-top:10px;font-size:0.85em;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">ğŸ© EDIä¼ç¥¨ã®å†…è¨³</div>
                    <div class="donut-container"><canvas id="ediDonut"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ© è²©å£²çµŒè·¯ã®å†…è¨³</div>
                    <div class="donut-container"><canvas id="directDonut"></canvas></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ æœˆåˆ¥æ¨ç§»</div>
                <canvas id="trend"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">ğŸ“‹ å–¶æ¥­æ‰€åˆ¥è©³ç´°ï¼ˆå‰æœˆæ¯”è¼ƒï¼‰</div>
                <table>
                    <thead>
                        <tr>
                            <th>å–¶æ¥­æ‰€</th>
                            <th>éƒ¨é–€</th>
                            <th>EDIç‡</th>
                            <th>EDIå‰æœˆæ¯”</th>
                            <th>ç›´è²©ç‡</th>
                            <th>ç›´è²©å‰æœˆæ¯”</th>
                            <th>EDIä»¶æ•°</th>
                            <th>æ‰‹å‹•ä»¶æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let c = {};
        let allData = [];
        
        // æœˆã®å¤‰æ›é–¢æ•°ï¼ˆ4æœˆ â†’ 2025-04ï¼‰
        function convertMonth(monthStr) {
            const monthMap = {
                '4æœˆ': '2025-04', '5æœˆ': '2025-05', '6æœˆ': '2025-06',
                '7æœˆ': '2025-07', '8æœˆ': '2025-08', '9æœˆ': '2025-09',
                '10æœˆ': '2025-10', '11æœˆ': '2025-11', '12æœˆ': '2025-12',
                '1æœˆ': '2026-01', '2æœˆ': '2026-02', '3æœˆ': '2026-03'
            };
            return monthMap[monthStr] || monthStr;
        }
        
        // å–¶æ¥­æ‰€ã®ã‚½ãƒ¼ãƒˆé †ã‚’å®šç¾©ï¼ˆAY* â†’ AJ* â†’ BY*ï¼‰
        function sortOffices(offices) {
            return offices.sort((a, b) => {
                const getPrefix = (office) => {
                    if (office.startsWith('AY')) return 1;
                    if (office.startsWith('AJ')) return 2;
                    if (office.startsWith('BY')) return 3;
                    return 4;
                };
                const prefixDiff = getPrefix(a) - getPrefix(b);
                return prefixDiff !== 0 ? prefixDiff : a.localeCompare(b);
            });
        }
        
        // CSVèª­ã¿è¾¼ã¿
        async function load() {
            try {
                const response = await fetch('data.csv?' + Date.now(), { cache: 'no-store' });
                const text = await response.text();
                parseCSV(text);
            } catch (e) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚data.csvã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // CSVè§£æ
        function parseCSV(text) {
            const lines = text.split('\n');
            const d = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const v = lines[i].split(',');
                
                d.push({
                    month: convertMonth(v[0]?.trim()),
                    office: v[1]?.trim(),
                    dept: v[2]?.trim(),
                    edi: parseInt(v[3]) || 0,
                    manual: parseInt(v[4]) || 0,
                    ediTotal: parseInt(v[5]) || 0,
                    direct: parseInt(v[6]) || 0,
                    indirect: parseInt(v[7]) || 0,
                    salesTotal: parseInt(v[8]) || 0
                });
            }
            
            if (d.length > 0) {
                allData = d;
                setupFilters();
                render(d);
            } else {
                alert('CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚');
            }
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupFilters() {
            // éƒ¨é–€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const depts = [...new Set(allData.map(x => x.dept))].sort();
            const deptSel = document.getElementById('deptFilter');
            deptSel.innerHTML = '<option value="all">ã™ã¹ã¦ã®éƒ¨é–€</option>';
            depts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSel.appendChild(opt);
            });
            
            // å–¶æ¥­æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
            const offices = sortOffices([...new Set(allData.map(x => x.office))]);
            const officeSel = document.getElementById('officeFilter');
            officeSel.innerHTML = '<option value="all">ã™ã¹ã¦ã®å–¶æ¥­æ‰€</option>';
            offices.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = o;
                officeSel.appendChild(opt);
            });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilter() {
            const dept = document.getElementById('deptFilter').value;
            const office = document.getElementById('officeFilter').value;
            let fd = allData;
            
            if (dept !== 'all') fd = fd.filter(x => x.dept === dept);
            if (office !== 'all') fd = fd.filter(x => x.office === office);
            
            render(fd);
        }
        
        // ç›¸é–¢ä¿‚æ•°ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
        function getCorrelationText(corr) {
            if (corr < -0.3) {
                return 'è² ã®ç›¸é–¢ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚é–“æ¥è²©å£²ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼çµŒç”±ï¼‰ãŒå¤šã„å–¶æ¥­æ‰€ã»ã©ã€ç›´è²©ç‡ãŒä½ããªã£ã¦ã„ã¾ã™ã€‚é–“æ¥è²©å£²ã®å–å¼•å…ˆãŒEDIå¯¾å¿œã—ã¦ã„ã‚Œã°ã€EDIç‡ã‚‚é«˜ããªã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚';
            } else if (corr > 0.3) {
                return 'æ­£ã®ç›¸é–¢ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç›´è²©ãŒå¤šã„å–¶æ¥­æ‰€ã§ã‚‚EDIç‡ãŒé«˜ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ç›´è²©é¡§å®¢ãŒEDIå¯¾å¿œã—ã¦ã„ã‚‹ã€ã¾ãŸã¯åˆ¥ã®è¦å› ãŒå½±éŸ¿ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
            } else {
                return 'æ˜ç¢ºãªç›¸é–¢ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã€‚EDIç‡ã¯è²©å£²çµŒè·¯ï¼ˆç›´è²©/é–“æ¥ï¼‰ã ã‘ã§ãªãã€å–å¼•å…ˆã®EDIå¯¾å¿œçŠ¶æ³ã«å¤§ããä¾å­˜ã—ã¦ã„ã¾ã™ã€‚é–“æ¥è²©å£²ãŒå¤šãã¦ã‚‚ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒEDIæœªå¯¾å¿œã§ã‚ã‚Œã°EDIç‡ã¯ä½ããªã‚Šã¾ã™ã€‚';
            }
        }
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        function render(d) {
            // KPIè¨ˆç®—
            const totEdi = d.reduce((s, x) => s + x.edi, 0);
            const totManual = d.reduce((s, x) => s + x.manual, 0);
            const totDirect = d.reduce((s, x) => s + x.direct, 0);
            const totIndirect = d.reduce((s, x) => s + x.indirect, 0);
            const ediBase = totEdi + totManual;
            const salesBase = totDirect + totIndirect;
            const ediRate = ediBase > 0 ? (totEdi / ediBase * 100).toFixed(1) : '0.0';
            const manualRate = ediBase > 0 ? (totManual / ediBase * 100).toFixed(1) : '0.0';
            const directRate = salesBase > 0 ? (totDirect / salesBase * 100).toFixed(1) : '0.0';
            const indirectRate = salesBase > 0 ? (totIndirect / salesBase * 100).toFixed(1) : '0.0';
            
            // KPIè¡¨ç¤º
            document.getElementById('ediCount').textContent = totEdi.toLocaleString();
            document.getElementById('ediRate').textContent = ediRate;
            document.getElementById('manualCount').textContent = totManual.toLocaleString();
            document.getElementById('manualRate').textContent = manualRate;
            document.getElementById('directCount').textContent = totDirect.toLocaleString();
            document.getElementById('directRate').textContent = directRate;
            document.getElementById('indirectCount').textContent = totIndirect.toLocaleString();
            document.getElementById('indirectRate').textContent = indirectRate;
            
            // æœˆåˆ¥ãƒ»å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ
            const officeMonthly = {};
            d.forEach(x => {
                if (!officeMonthly[x.office]) officeMonthly[x.office] = {};
                if (!officeMonthly[x.office][x.month]) {
                    officeMonthly[x.office][x.month] = { dept: x.dept, edi: 0, manual: 0, direct: 0, indirect: 0 };
                }
                officeMonthly[x.office][x.month].edi += x.edi;
                officeMonthly[x.office][x.month].manual += x.manual;
                officeMonthly[x.office][x.month].direct += x.direct;
                officeMonthly[x.office][x.month].indirect += x.indirect;
            });
            
            const months = [...new Set(d.map(x => x.month))].sort();
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length >= 2 ? months[months.length - 2] : null;
            
            // å–¶æ¥­æ‰€ã”ã¨ã®å…¨æœŸé–“é›†è¨ˆ
            const officeData = {};
            d.forEach(x => {
                if (!officeData[x.office]) {
                    officeData[x.office] = { office: x.office, dept: x.dept, edi: 0, manual: 0, direct: 0, indirect: 0 };
                }
                officeData[x.office].edi += x.edi;
                officeData[x.office].manual += x.manual;
                officeData[x.office].direct += x.direct;
                officeData[x.office].indirect += x.indirect;
            });
            
            const offices = sortOffices(Object.keys(officeData));
            const scatterData = offices.map(office => {
                const o = officeData[office];
                const eb = o.edi + o.manual;
                const sb = o.direct + o.indirect;
                return {
                    x: sb > 0 ? (o.direct / sb * 100) : 0,
                    y: eb > 0 ? (o.edi / eb * 100) : 0,
                    office: o.office,
                    dept: o.dept
                };
            });
            
            // ç›¸é–¢ä¿‚æ•°è¨ˆç®—
            if (scatterData.length > 1) {
                const xAvg = scatterData.reduce((s, p) => s + p.x, 0) / scatterData.length;
                const yAvg = scatterData.reduce((s, p) => s + p.y, 0) / scatterData.length;
                let num = 0, denX = 0, denY = 0;
                scatterData.forEach(p => {
                    const dx = p.x - xAvg;
                    const dy = p.y - yAvg;
                    num += dx * dy;
                    denX += dx * dx;
                    denY += dy * dy;
                });
                const corr = denX > 0 && denY > 0 ? num / Math.sqrt(denX * denY) : 0;
                document.getElementById('corrValue').textContent = corr.toFixed(2);
                document.getElementById('corrText').textContent = getCorrelationText(corr);
            } else {
                document.getElementById('corrValue').textContent = '-';
                document.getElementById('corrText').textContent = 'ç›¸é–¢ä¿‚æ•°ã‚’è¨ˆç®—ã™ã‚‹ã«ã¯è¤‡æ•°ã®å–¶æ¥­æ‰€ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚';
            }
            
            // 4è±¡é™åˆ†é¡
            const avgX = scatterData.reduce((s, p) => s + p.x, 0) / scatterData.length;
            const avgY = scatterData.reduce((s, p) => s + p.y, 0) / scatterData.length;
            const q1 = [], q2 = [], q3 = [], q4 = [];
            scatterData.forEach(p => {
                if (p.y >= avgY && p.x < avgX) q1.push(p.office);
                else if (p.y >= avgY && p.x >= avgX) q2.push(p.office);
                else if (p.y < avgY && p.x < avgX) q3.push(p.office);
                else q4.push(p.office);
            });
            document.getElementById('q1').textContent = q1.join(', ') || 'ãªã—';
            document.getElementById('q2').textContent = q2.join(', ') || 'ãªã—';
            document.getElementById('q3').textContent = q3.join(', ') || 'ãªã—';
            document.getElementById('q4').textContent = q4.join(', ') || 'ãªã—';
            
            // æ•£å¸ƒå›³
            if (c.sc) c.sc.destroy();
            const deptColors = { 'é¦–éƒ½åœGPæ”¯åº—': '#667eea', 'ç—…é™¢å–¶æ¥­éƒ¨': '#f5576c', 'åŒ»ç™‚åœå–¶æ¥­éƒ¨': '#4facfe' };
            const datasets = {};
            scatterData.forEach(p => {
                if (!datasets[p.dept]) {
                    datasets[p.dept] = { label: p.dept, data: [], backgroundColor: deptColors[p.dept] || '#999' };
                }
                datasets[p.dept].data.push({ x: p.x, y: p.y, label: p.office });
            });
            c.sc = new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: { datasets: Object.values(datasets) },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.label}: EDIç‡${ctx.parsed.y.toFixed(1)}%, ç›´è²©ç‡${ctx.parsed.x.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'ç›´è²©ç‡ (%)' }, min: 0, max: 100 },
                        y: { title: { display: true, text: 'EDIç‡ (%)' }, min: 0, max: 100 }
                    }
                }
            });
            
            // ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•
            if (c.ed) c.ed.destroy();
            c.ed = new Chart(document.getElementById('ediDonut'), {
                type: 'doughnut',
                data: {
                    labels: ['âœ… EDI', 'âš ï¸ æ‰‹å‹•'],
                    datasets: [{
                        data: [totEdi, totManual],
                        backgroundColor: ['#667eea', '#ffa726'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            
            if (c.dd) c.dd.destroy();
            c.dd = new Chart(document.getElementById('directDonut'), {
                type: 'doughnut',
                data: {
                    labels: ['ğŸ¯ ç›´è²©', 'ğŸ“¦ é–“æ¥'],
                    datasets: [{
                        data: [totDirect, totIndirect],
                        backgroundColor: ['#f5576c', '#4facfe'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            
            // æœˆåˆ¥æ¨ç§»
            const monthly = {};
            d.forEach(x => {
                if (!monthly[x.month]) monthly[x.month] = { edi: 0, manual: 0, direct: 0, indirect: 0 };
                monthly[x.month].edi += x.edi;
                monthly[x.month].manual += x.manual;
                monthly[x.month].direct += x.direct;
                monthly[x.month].indirect += x.indirect;
            });
            const mons = Object.keys(monthly).sort();
            const ediRates = mons.map(m => {
                const b = monthly[m].edi + monthly[m].manual;
                return b > 0 ? (monthly[m].edi / b * 100).toFixed(1) : '0';
            });
            const directRates = mons.map(m => {
                const b = monthly[m].direct + monthly[m].indirect;
                return b > 0 ? (monthly[m].direct / b * 100).toFixed(1) : '0';
            });
            
            if (c.t) c.t.destroy();
            c.t = new Chart(document.getElementById('trend'), {
                type: 'line',
                data: {
                    labels: mons,
                    datasets: [
                        { label: 'EDIç‡(%)', data: ediRates, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.2)', tension: 0.4, fill: true, borderWidth: 3 },
                        { label: 'ç›´è²©ç‡(%)', data: directRates, borderColor: '#f5576c', backgroundColor: 'rgba(245,87,108,0.2)', tension: 0.4, fill: true, borderWidth: 3 }
                    ]
                },
                options: { responsive: true, scales: { y: { max: 100 } } }
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‰æœˆæ¯”ä»˜ãï¼‰
            let tb = '';
            offices.forEach(office => {
                const lastData = officeMonthly[office] ? officeMonthly[office][lastMonth] : null;
                const prevData = prevMonth && officeMonthly[office] ? officeMonthly[office][prevMonth] : null;
                
                if (!lastData) return;
                
                const lastEdiBase = lastData.edi + lastData.manual;
                const lastSalesBase = lastData.direct + lastData.indirect;
                const lastEdiRate = lastEdiBase > 0 ? (lastData.edi / lastEdiBase * 100).toFixed(1) : '-';
                const lastDirectRate = lastSalesBase > 0 ? (lastData.direct / lastSalesBase * 100).toFixed(1) : '-';
                
                let ediChange = '-', ediClass = '', directChange = '-', directClass = '';
                
                if (prevData) {
                    const prevEdiBase = prevData.edi + prevData.manual;
                    const prevSalesBase = prevData.direct + prevData.indirect;
                    
                    if (prevEdiBase > 0 && lastEdiRate !== '-') {
                        const prevEdiRate = (prevData.edi / prevEdiBase * 100);
                        const ediDiff = (parseFloat(lastEdiRate) - prevEdiRate).toFixed(1);
                        ediChange = ediDiff > 0 ? `â†— +${ediDiff}%` : `â†˜ ${ediDiff}%`;
                        ediClass = ediDiff > 0 ? 'up' : 'down';
                    }
                    
                    if (prevSalesBase > 0 && lastDirectRate !== '-') {
                        const prevDirectRate = (prevData.direct / prevSalesBase * 100);
                        const directDiff = (parseFloat(lastDirectRate) - prevDirectRate).toFixed(1);
                        directChange = directDiff > 0 ? `â†— +${directDiff}%` : `â†˜ ${directDiff}%`;
                        directClass = directDiff > 0 ? 'up' : 'down';
                    }
                }
                
                tb += `<tr>
                    <td>${office}</td>
                    <td>${lastData.dept}</td>
                    <td><strong>${lastEdiRate}%</strong></td>
                    <td class="${ediClass}">${ediChange}</td>
                    <td><strong>${lastDirectRate}%</strong></td>
                    <td class="${directClass}">${directChange}</td>
                    <td>${lastData.edi.toLocaleString()}</td>
                    <td style="color:#ffa726;font-weight:bold">${lastData.manual.toLocaleString()}</td>
                </tr>`;
            });
            document.getElementById('tbody').innerHTML = tb;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', load);
    </script>
</body>
</html>