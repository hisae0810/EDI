<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIç‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; }
        .refresh-btn { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .refresh-btn:hover { background: white; color: #667eea; transform: rotate(180deg); }
        .filter-section { background: #f8f9fa; padding: 20px 30px; border-bottom: 2px solid #e9ecef; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-label { font-weight: bold; color: #333; }
        .filter-select { padding: 10px 20px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; background: white; cursor: pointer; min-width: 180px; }
        .dashboard { padding: 30px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .kpi-card.warning { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); }
        .kpi-label { font-size: 0.9em; opacity: 0.9; }
        .kpi-value { font-size: 2.5em; font-weight: bold; margin-top: 10px; }
        .chart-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .chart-title { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; }
        .chart-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .under-construction { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; padding: 60px 25px; border-radius: 15px; text-align: center; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .under-construction h2 { font-size: 2em; margin-bottom: 15px; }
        .under-construction p { font-size: 1.1em; opacity: 0.9; }
        .construction-icon { font-size: 4em; margin-bottom: 20px; animation: swing 2s ease-in-out infinite; }
        @keyframes swing { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: center; border: 2px solid #e0e0e0; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; }
        tr:hover { background: rgba(0,0,0,0.02); }
        .up { color: #38ef7d; font-weight: bold; }
        .down { color: #f5576c; font-weight: bold; }
        .detail-table th, .detail-table td { text-align: left; }
        .heatmap-high { background: #4caf50; color: white; font-weight: bold; }
        .heatmap-medium { background: #ffc107; color: white; font-weight: bold; }
        .heatmap-low { background: #f44336; color: white; font-weight: bold; }
        .office-name { background: #f5f5f5; font-weight: bold; text-align: left !important; }
        .legend { display: flex; gap: 15px; justify-content: center; margin: 15px 0; font-size: 0.85em; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="refresh-btn" onclick="location.reload(true)">ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
            <h1>ğŸ“Š EDIç‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>å—é–¢æ±æ”¯åº— - é›»å­ãƒ‡ãƒ¼ã‚¿äº¤æ›ã®åˆ©ç”¨çŠ¶æ³ã‚’å¯è¦–åŒ–</p>
        </div>
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">ğŸ¢ éƒ¨é–€:</span>
                <select id="deptFilter" class="filter-select" onchange="applyFilter()">
                    <option value="all">ã™ã¹ã¦ã®éƒ¨é–€</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">ğŸ“ å–¶æ¥­æ‰€:</span>
                <select id="officeFilter" class="filter-select" onchange="applyFilter()">
                    <option value="all">ã™ã¹ã¦ã®å–¶æ¥­æ‰€</option>
                </select>
            </div>
        </div>
        <div class="dashboard">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">âœ… EDIä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="ediCount">0</span><span style="font-size:0.4em"> (<span id="ediRate">0</span>%)</span></div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-label">âš ï¸ æ‰‹å‹•ä¼ç¥¨ä»¶æ•°</div>
                    <div class="kpi-value"><span id="manualCount">0</span><span style="font-size:0.4em"> (<span id="manualRate">0</span>%)</span></div>
                </div>
            </div>
            
            <!-- EDIç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“Š æœˆåˆ¥æ¨ç§»ï¼šå–¶æ¥­æ‰€åˆ¥EDIç‡</div>
                <div class="chart-section">
                    <h3 style="margin-bottom: 15px; font-size: 1.1em;">ğŸ“Š EDIä¼ç¥¨ vs æ‰‹å‹•ä¼ç¥¨ï¼ˆæœˆåˆ¥æ¨ç§»ï¼‰</h3>
                    <canvas id="ediTrendBar"></canvas>
                </div>
                <div class="chart-section">
                    <h3 style="margin-bottom: 15px; font-size: 1.1em;">ğŸ¨ EDIç‡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span>é«˜ã„ï¼ˆ80%ä»¥ä¸Šï¼‰</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffc107;"></div>
                            <span>ä¸­ç¨‹åº¦ï¼ˆ60-80%ï¼‰</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f44336;"></div>
                            <span>ä½ã„ï¼ˆ60%æœªæº€ï¼‰</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="ediHeatmap"></table>
                    </div>
                </div>
            </div>

            <!-- ç›´è²©ç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå·¥äº‹ä¸­ï¼‰ -->
            <div class="under-construction">
                <div class="construction-icon">ğŸš§</div>
                <h2>ç›´è²©ç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - æº–å‚™ä¸­</h2>
                <p>ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºæ–¹æ³•ã‚’è¦‹ç›´ã—ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
                <p style="margin-top: 10px; font-size: 0.9em;">Coming Soon...</p>
            </div>

            <!-- å–¶æ¥­æ‰€åˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“‹ å–¶æ¥­æ‰€åˆ¥EDIç‡è©³ç´°ï¼ˆå‰æœˆæ¯”è¼ƒï¼‰</div>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>å–¶æ¥­æ‰€</th>
                            <th>éƒ¨é–€</th>
                            <th>EDIç‡</th>
                            <th>EDIå‰æœˆæ¯”</th>
                            <th>EDIä»¶æ•°</th>
                            <th>æ‰‹å‹•ä»¶æ•°</th>
                            <th>EDIå¯¾è±¡ä¼ç¥¨åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let c = {};
        let allData = [];
        
        // æœˆã®å¤‰æ›é–¢æ•°ï¼ˆ4æœˆ â†’ 2025-04ï¼‰
        function convertMonth(monthStr) {
            const monthMap = {
                '4æœˆ': '2025-04', '5æœˆ': '2025-05', '6æœˆ': '2025-06',
                '7æœˆ': '2025-07', '8æœˆ': '2025-08', '9æœˆ': '2025-09',
                '10æœˆ': '2025-10', '11æœˆ': '2025-11', '12æœˆ': '2025-12',
                '1æœˆ': '2026-01', '2æœˆ': '2026-02', '3æœˆ': '2026-03'
            };
            return monthMap[monthStr] || monthStr;
        }
        
        // å–¶æ¥­æ‰€ã®ã‚½ãƒ¼ãƒˆé †ã‚’å®šç¾©ï¼ˆAY* â†’ AJ* â†’ BY*ï¼‰
        function sortOffices(offices) {
            return offices.sort((a, b) => {
                const getPrefix = (office) => {
                    if (office.startsWith('AY')) return 1;
                    if (office.startsWith('AJ')) return 2;
                    if (office.startsWith('BY')) return 3;
                    return 4;
                };
                const prefixDiff = getPrefix(a) - getPrefix(b);
                return prefixDiff !== 0 ? prefixDiff : a.localeCompare(b);
            });
        }
        
        // CSVèª­ã¿è¾¼ã¿
        async function load() {
            try {
                const response = await fetch('data.csv?' + Date.now(), { cache: 'no-store' });
                const text = await response.text();
                parseCSV(text);
            } catch (e) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚data.csvã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // CSVè§£æ
        function parseCSV(text) {
            const lines = text.split('\n');
            const d = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const v = lines[i].split(',');
                d.push({
                    month: convertMonth(v[0]?.trim()),
                    office: v[1]?.trim(),
                    dept: v[2]?.trim(),
                    edi: parseInt(v[3]) || 0,
                    manual: parseInt(v[4]) || 0,
                    ediTotal: parseInt(v[5]) || 0,
                    direct: parseInt(v[6]) || 0,
                    indirect: parseInt(v[7]) || 0,
                    salesTotal: parseInt(v[8]) || 0
                });
            }
            if (d.length > 0) {
                allData = d;
                setupFilters();
                render(d);
            } else {
                alert('CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚');
            }
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupFilters() {
            const depts = [...new Set(allData.map(x => x.dept))].sort();
            const deptSel = document.getElementById('deptFilter');
            deptSel.innerHTML = '<option value="all">ã™ã¹ã¦ã®éƒ¨é–€</option>';
            depts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSel.appendChild(opt);
            });
            
            const offices = sortOffices([...new Set(allData.map(x => x.office))]);
            const officeSel = document.getElementById('officeFilter');
            officeSel.innerHTML = '<option value="all">ã™ã¹ã¦ã®å–¶æ¥­æ‰€</option>';
            offices.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = o;
                officeSel.appendChild(opt);
            });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilter() {
            const dept = document.getElementById('deptFilter').value;
            const office = document.getElementById('officeFilter').value;
            let fd = allData;
            if (dept !== 'all') fd = fd.filter(x => x.dept === dept);
            if (office !== 'all') fd = fd.filter(x => x.office === office);
            render(fd);
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ã‚»ãƒ«ã‚¯ãƒ©ã‚¹ã‚’å–å¾—ï¼ˆEDIç‡ç”¨ï¼‰
        function getEdiHeatmapClass(rate) {
            if (rate >= 80) return 'heatmap-high';
            if (rate >= 60) return 'heatmap-medium';
            return 'heatmap-low';
        }
        
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        function render(d) {
            // KPIè¨ˆç®—
            const totEdi = d.reduce((s, x) => s + x.edi, 0);
            const totManual = d.reduce((s, x) => s + x.manual, 0);
            const ediBase = totEdi + totManual;
            const ediRate = ediBase > 0 ? (totEdi / ediBase * 100).toFixed(1) : '0.0';
            const manualRate = ediBase > 0 ? (totManual / ediBase * 100).toFixed(1) : '0.0';
            
            // KPIè¡¨ç¤º
            document.getElementById('ediCount').textContent = totEdi.toLocaleString();
            document.getElementById('ediRate').textContent = ediRate;
            document.getElementById('manualCount').textContent = totManual.toLocaleString();
            document.getElementById('manualRate').textContent = manualRate;
            
            // æœˆåˆ¥ãƒ»å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ
            const officeMonthly = {};
            d.forEach(x => {
                if (!officeMonthly[x.office]) officeMonthly[x.office] = {};
                if (!officeMonthly[x.office][x.month]) {
                    officeMonthly[x.office][x.month] = { dept: x.dept, edi: 0, manual: 0 };
                }
                officeMonthly[x.office][x.month].edi += x.edi;
                officeMonthly[x.office][x.month].manual += x.manual;
            });
            
            const months = [...new Set(d.map(x => x.month))].sort();
            const lastMonth = months[months.length - 1];
            const prevMonth = months.length >= 2 ? months[months.length - 2] : null;
            const offices = sortOffices([...new Set(d.map(x => x.office))]);
            
            // æœˆåˆ¥é›†è¨ˆï¼ˆæ£’ã‚°ãƒ©ãƒ•ç”¨ï¼‰
            const monthly = {};
            d.forEach(x => {
                if (!monthly[x.month]) monthly[x.month] = { edi: 0, manual: 0 };
                monthly[x.month].edi += x.edi;
                monthly[x.month].manual += x.manual;
            });
            
            const ediData = months.map(m => monthly[m].edi);
            const manualData = months.map(m => monthly[m].manual);
            
            // EDIä¼ç¥¨ã®æ£’ã‚°ãƒ©ãƒ•
            if (c.ebt) c.ebt.destroy();
            c.ebt = new Chart(document.getElementById('ediTrendBar'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'EDIä¼ç¥¨',
                            data: ediData,
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'æ‰‹å‹•ä¼ç¥¨',
                            data: manualData,
                            backgroundColor: '#ffa726'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'ä¼ç¥¨ä»¶æ•°' } }
                    }
                }
            });
            
            // EDIç‡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
            let ediHeatHtml = '<thead><tr><th>å–¶æ¥­æ‰€</th>';
            months.forEach(m => { ediHeatHtml += `<th>${m}</th>`; });
            ediHeatHtml += '<th>å¤‰åŒ–</th></tr></thead><tbody>';
            
            offices.forEach(office => {
                ediHeatHtml += `<tr><td class="office-name">${office}</td>`;
                let prevRate = null;
                let lastRate = null;
                months.forEach((month, idx) => {
                    const data = officeMonthly[office]?.[month];
                    if (data) {
                        const base = data.edi + data.manual;
                        const rate = base > 0 ? (data.edi / base * 100) : 0;
                        const rateStr = rate.toFixed(1);
                        const cls = getEdiHeatmapClass(rate);
                        ediHeatHtml += `<td class="${cls}">${rateStr}%</td>`;
                        if (idx === months.length - 1) lastRate = rate;
                        if (idx === months.length - 2) prevRate = rate;
                    } else {
                        ediHeatHtml += '<td>-</td>';
                    }
                });
                
                if (prevRate !== null && lastRate !== null) {
                    const diff = (lastRate - prevRate).toFixed(1);
                    const color = diff > 0 ? '#4caf50' : diff < 0 ? '#f5576c' : '#666';
                    const sign = diff > 0 ? '+' : '';
                    ediHeatHtml += `<td style="color:${color};font-weight:bold;">${sign}${diff}%</td>`;
                } else {
                    ediHeatHtml += '<td>-</td>';
                }
                ediHeatHtml += '</tr>';
            });
            ediHeatHtml += '</tbody>';
            document.getElementById('ediHeatmap').innerHTML = ediHeatHtml;
            
            // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‰æœˆæ¯”ä»˜ãï¼‰
            let tb = '';
            offices.forEach(office => {
                const lastData = officeMonthly[office]?.[lastMonth];
                const prevData = prevMonth && officeMonthly[office] ? officeMonthly[office][prevMonth] : null;
                
                if (!lastData) return;
                
                const lastEdiBase = lastData.edi + lastData.manual;
                const lastEdiRate = lastEdiBase > 0 ? (lastData.edi / lastEdiBase * 100).toFixed(1) : '-';
                
                let ediChange = '-', ediClass = '';
                if (prevData) {
                    const prevEdiBase = prevData.edi + prevData.manual;
                    if (prevEdiBase > 0 && lastEdiRate !== '-') {
                        const prevEdiRate = (prevData.edi / prevEdiBase * 100);
                        const ediDiff = (parseFloat(lastEdiRate) - prevEdiRate).toFixed(1);
                        ediChange = ediDiff > 0 ? `â†— +${ediDiff}%` : `â†˜ ${ediDiff}%`;
                        ediClass = ediDiff > 0 ? 'up' : 'down';
                    }
                }
                
                tb += `<tr>
                    <td>${office}</td>
                    <td>${lastData.dept}</td>
                    <td><strong>${lastEdiRate}%</strong></td>
                    <td class="${ediClass}">${ediChange}</td>
                    <td>${lastData.edi.toLocaleString()}</td>
                    <td style="color:#ffa726;font-weight:bold">${lastData.manual.toLocaleString()}</td>
                    <td>${lastEdiBase.toLocaleString()}</td>
                </tr>`;
            });
            document.getElementById('tbody').innerHTML = tb;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', load);
    </script>
</body>
</html>