<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMå“å·®é¡å¯¾ç­–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 15px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .data-status {
            padding: 15px 30px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            margin: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .data-status.loading {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        .data-status.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .data-status.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .period-selector {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }
        .period-btn {
            padding: 10px 30px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .period-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .period-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .view-toggle {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: center;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 10px 25px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border-color: #2196F3;
        }
        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .filters {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
            transition: border-color 0.3s;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .card h3 {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            line-height: 1.4;
        }
        .card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1e3c72;
        }
        .card .label {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.5;
        }
        .card .label small {
            font-size: 9px;
            color: #999;
            display: block;
            margin-top: 3px;
            font-style: italic;
        }
        .section {
            padding: 30px;
            background: white;
        }
        .section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1e3c72;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            position: relative;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }
        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        th {
            padding: 12px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 2px solid #1e3c72;
        }
        th small {
            font-size: 9px;
            color: #b3d4fc;
            font-weight: normal;
            display: block;
            margin-top: 2px;
            font-style: italic;
        }
        td {
            padding: 12px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 12px;
        }
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        .dept-summary-row {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            font-weight: bold;
            border-top: 3px solid #1976d2;
            border-bottom: 3px solid #1976d2;
        }
        .dept-summary-row td {
            padding: 15px 8px;
            font-size: 13px;
            color: #0d47a1;
        }
        .dept-summary-row:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
        }
        .col-product {
            width: 100px;
            min-width: 80px;
        }
        .col-progress {
            width: 250px;
            min-width: 200px;
        }
        .certainty-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin: 2px;
        }
        .certainty-k { background: #9C27B0; color: white; }
        .certainty-n { background: #E91E63; color: white; }
        .certainty-a { background: #FF5722; color: white; }
        .certainty-b { background: #FF9800; color: white; }
        .certainty-c { background: #FFC107; color: black; }
        .certainty-d { background: #CDDC39; color: black; }
        .progress-bar-container {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            transition: width 0.5s ease;
        }
        .progress-bar-fill.excellent {
            background: linear-gradient(90deg, #9C27B0 0%, #BA68C8 100%);
        }
        .progress-bar-fill.good {
            background: linear-gradient(90deg, #E91E63 0%, #F06292 100%);
        }
        .progress-bar-fill.normal {
            background: linear-gradient(90deg, #FFC0CB 0%, #FFB6C1 100%);
        }
        .progress-bar-fill.low {
            background: linear-gradient(90deg, #E0E0E0 0%, #BDBDBD 100%);
        }
        .progress-bar-fill.certainty-k {
            background: linear-gradient(90deg, #9C27B0 0%, #BA68C8 100%);
        }
        .progress-bar-fill.certainty-n {
            background: linear-gradient(90deg, #E91E63 0%, #F06292 100%);
        }
        .progress-bar-fill.certainty-a {
            background: linear-gradient(90deg, #FF5722 0%, #FF7043 100%);
        }
        .progress-bar-fill.certainty-b {
            background: linear-gradient(90deg, #FF9800 0%, #FFB74D 100%);
        }
        .progress-bar-fill.certainty-c {
            background: linear-gradient(90deg, #FFC107 0%, #FFD54F 100%);
            color: #333;
        }
        .progress-bar-fill.certainty-d {
            background: linear-gradient(90deg, #CDDC39 0%, #DCE775 100%);
            color: #333;
        }
        .amount {
            color: #2E7D32;
            font-weight: 600;
        }
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #loading .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        #loading .loading-spinner {
            font-size: 24px;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .legend {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }
        .legend h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1e3c72;
        }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }
        .legend-text {
            flex: 1;
        }
        .legend-text .title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .legend-text .range {
            font-size: 12px;
            color: #666;
        }
        @media (max-width: 768px) {
            .summary {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            .filters {
                flex-direction: column;
                padding: 15px;
            }
            .filter-group {
                width: 100%;
            }
            .filter-group select, .filter-group input {
                width: 100%;
                min-width: auto;
            }
            .table-container {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-content">
            <div class="loading-spinner">â³</div>
            <div>ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š TMå“è²©å£²çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>å–¶æ¥­éƒ¨åˆ¥ãƒ»å–¶æ¥­æ‰€åˆ¥ãƒ»æ©Ÿç¨®åˆ¥ãƒ»å€‹äººåˆ¥ãƒ»ç¢ºåº¦åˆ¥ãƒ»é‡‘é¡åˆ†æ</p>
        </div>
        <div class="data-status" id="dataStatus">
            <div><strong>ğŸ“¡ ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹:</strong> <span id="statusText">åˆæœŸåŒ–ä¸­...</span></div>
            <div><strong>ğŸ“… æœ€çµ‚æ›´æ–°:</strong> <span id="lastUpdate">-</span></div>
        </div>
        <div class="period-selector">
            <button class="period-btn active" data-period="all">ğŸ“… å…¨æœŸé–“</button>
            <button class="period-btn" data-period="first">ğŸŒ¸ ä¸ŠæœŸï¼ˆ4-9æœˆï¼‰</button>
            <button class="period-btn" data-period="second">â„ï¸ ä¸‹æœŸï¼ˆ10-3æœˆï¼‰</button>
        </div>
        <div class="view-toggle">
            <button class="view-btn" data-view="dept">ğŸ¢ å–¶æ¥­éƒ¨åˆ¥</button>
            <button class="view-btn active" data-view="office">ğŸª å–¶æ¥­æ‰€åˆ¥</button>
            <button class="view-btn" data-view="person">ğŸ‘¤ å€‹äººåˆ¥</button>
            <button class="view-btn" data-view="product">ğŸ“¦ æ©Ÿç¨®åˆ¥</button>
            <button class="view-btn" data-view="certainty">ğŸ¯ ç¢ºåº¦åˆ¥</button>
            <button class="view-btn" data-view="amount">ğŸ’° é‡‘é¡åˆ¥</button>
        </div>
        <div class="filters">
            <div class="filter-group">
                <label for="deptFilter">å–¶æ¥­éƒ¨</label>
                <select id="deptFilter"><option value="">å…¨å–¶æ¥­éƒ¨</option></select>
            </div>
            <div class="filter-group">
                <label for="officeFilter">å–¶æ¥­æ‰€</label>
                <select id="officeFilter"><option value="">å…¨å–¶æ¥­æ‰€</option></select>
            </div>
            <div class="filter-group">
                <label for="personFilter">å–¶æ¥­å“¡</label>
                <select id="personFilter"><option value="">å…¨å–¶æ¥­å“¡</option></select>
            </div>
            <div class="filter-group">
                <label for="productFilter">æ©Ÿç¨®</label>
                <select id="productFilter"><option value="">å…¨æ©Ÿç¨®</option></select>
            </div>
            <div class="filter-group">
                <label for="searchInput">æ¤œç´¢</label>
                <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
            </div>
        </div>
        <div style="padding: 15px 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <strong>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</strong> <span id="viewMode">å–¶æ¥­æ‰€åˆ¥</span> |
                <strong>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:</strong> <span id="dataCount">0</span>ä»¶ |
                <strong>è¡¨ç¤ºä¸­:</strong> <span id="displayCount">0</span>ä»¶
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display:none;">
                <button class="period-btn" onclick="document.getElementById('csvFileInput').click()" style="padding: 8px 16px; font-size: 12px;">ğŸ“ è²©å£²ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                <input type="file" id="priceFileInput" accept=".csv,.xlsx,.xls" style="display:none;">
                <button class="period-btn" onclick="document.getElementById('priceFileInput').click()" style="padding: 8px 16px; font-size: 12px;">ğŸ’° ä¾¡æ ¼è¡¨èª­è¾¼</button>
                <button class="period-btn" onclick="resetFilters()" style="padding: 8px 16px; font-size: 12px;">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="period-btn" onclick="reloadData()" style="padding: 8px 16px; font-size: 12px;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†èª­è¾¼</button>
            </div>
        </div>
        <div class="summary">
            <div class="card">
                <h3>ğŸ“ˆ è¨ˆç”»å°æ•°</h3>
                <div class="value" id="totalPlan">0</div>
                <div class="label">å°</div>
            </div>
            <div class="card">
                <h3>ğŸ’° è¨ˆç”»é‡‘é¡ï¼ˆè¨ˆç®—å€¤ï¼‰</h3>
                <div class="value" id="totalPlanAmount">0</div>
                <div class="label">ç™¾ä¸‡å††<small>å¹³å‡è²©å£²ä¾¡æ ¼ã‚ˆã‚Šç®—å‡º</small></div>
            </div>
            <div class="card">
                <h3>âœ… è²©å£²å°æ•°</h3>
                <div class="value" id="totalSales">0</div>
                <div class="label">å° | é”æˆç‡: <span id="salesRate">0%</span></div>
            </div>
            <div class="card">
                <h3>ğŸ’° è²©å£²é‡‘é¡ï¼ˆè¨ˆç®—å€¤ï¼‰</h3>
                <div class="value" id="totalSalesAmount">0</div>
                <div class="label">ç™¾ä¸‡å††<small>å¹³å‡è²©å£²ä¾¡æ ¼ã‚ˆã‚Šç®—å‡º</small>é”æˆç‡: <span id="salesAmountRate">0%</span></div>
            </div>
            <div class="card">
                <h3>ğŸ’¼ å•†è«‡ä»¶æ•°</h3>
                <div class="value" id="totalDeals">0</div>
                <div class="label">ä»¶<small>ç¢ºåº¦K+N+A+B+C+D<br>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®ã¿é›†è¨ˆ</small></div>
            </div>
            <div class="card">
                <h3>ğŸ’° å•†è«‡é‡‘é¡ï¼ˆè¨ˆç®—å€¤ï¼‰</h3>
                <div class="value" id="totalDealsAmount">0</div>
                <div class="label">ç™¾ä¸‡å††<small>å¹³å‡è²©å£²ä¾¡æ ¼ã‚ˆã‚Šç®—å‡º<br>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®ã¿é›†è¨ˆ</small></div>
            </div>
        </div>
        <div class="section">
            <h2 id="sectionTitle">ğŸª å–¶æ¥­æ‰€åˆ¥ å°æ•°ãƒ»é‡‘é¡é”æˆç‡</h2>
            <div class="table-container">
                <table>
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="legend">
            <h3>ğŸ“Š é”æˆç‡ã®è‰²åˆ†ã‘èª¬æ˜</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(90deg, #9C27B0 0%, #BA68C8 100%);"></div>
                    <div class="legend-text"><div class="title">â­â­â­ å„ªç§€</div><div class="range">80%ä»¥ä¸Š</div></div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(90deg, #E91E63 0%, #F06292 100%);"></div>
                    <div class="legend-text"><div class="title">â­â­ è‰¯å¥½</div><div class="range">60-79%</div></div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(90deg, #FFC0CB 0%, #FFB6C1 100%);"></div>
                    <div class="legend-text"><div class="title">â­ è¦åŠªåŠ›</div><div class="range">40-59%</div></div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(90deg, #E0E0E0 0%, #BDBDBD 100%);"></div>
                    <div class="legend-text"><div class="title">âš ï¸ è¦æ³¨æ„</div><div class="range">40%æœªæº€</div></div>
                </div>
            </div>
            <h3 style="margin-top: 20px;">ğŸ¯ ç¢ºåº¦ã®èª¬æ˜</h3>
            <div class="legend-grid">
                <div class="legend-item"><span class="certainty-badge certainty-k">K</span><div class="legend-text"><div class="title">å¥‘ç´„æ¸ˆã¿</div></div></div>
                <div class="legend-item"><span class="certainty-badge certainty-n">N</span><div class="legend-text"><div class="title">å†…ç¤ºã‚ã‚Š</div></div></div>
                <div class="legend-item"><span class="certainty-badge certainty-a">A</span><div class="legend-text"><div class="title">ç¢ºåº¦A</div></div></div>
                <div class="legend-item"><span class="certainty-badge certainty-b">B</span><div class="legend-text"><div class="title">ç¢ºåº¦B</div></div></div>
                <div class="legend-item"><span class="certainty-badge certainty-c">C</span><div class="legend-text"><div class="title">ç¢ºåº¦C</div></div></div>
                <div class="legend-item"><span class="certainty-badge certainty-d">D</span><div class="legend-text"><div class="title">ç¢ºåº¦D</div></div></div>
            </div>
        </div>
    </div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let productMaster = {
            'CSM': { price: 955, profitRate: 16.9, profit: 161 },
            'BSM': { price: 655, profitRate: 42.2, profit: 276 },
            'PVM': { price: 525, profitRate: 42.5, profit: 223 },
            'SVM': { price: 282, profitRate: 50.3, profit: 142 },
            'CNS': { price: 2109, profitRate: 60.2, profit: 1270 },
            'WEP': { price: 1414, profitRate: 52.9, profit: 748 },
            'é€ä¿¡æ©Ÿ': { price: 181, profitRate: 50.6, profit: 92 },
            'TEC-8/5': { price: 751, profitRate: 56.4, profit: 424 },
            'EMS': { price: 1939, profitRate: 68.6, profit: 1330 },
            'HAMILTON': { price: 2877, profitRate: 15.1, profit: 434 },
            'NKV-NPPV': { price: 1857, profitRate: 47.5, profit: 882 },
            'å¿ƒé›»è¨ˆ': { price: 804, profitRate: 50.9, profit: 409 },
            'DSC,QP': { price: 962, profitRate: 47.4, profit: 456 },
            'ãƒ›ãƒ«ã‚¿ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ€': { price: 234, profitRate: 51.8, profit: 121 },
            'STS': { price: 2824, profitRate: 33.1, profit: 935 },
            'RMC': { price: 1156, profitRate: 30.4, profit: 351 },
            'EEG': { price: 969, profitRate: 47.9, profit: 464 },
            'MEB/MEE': { price: 1516, profitRate: 51.6, profit: 782 },
            'MEK': { price: 1562, profitRate: 34.2, profit: 534 },
            'CHM': { price: 437, profitRate: 22.5, profit: 98 }
        };
        let allData = [];
        let filteredData = [];
        let currentView = 'office';
        let currentPeriod = 'all';
        let priceListLoaded = false;
        let autoLoadAttempted = false;
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }
        
        function updateStatus(text, type = 'info') {
            const statusDiv = document.getElementById('dataStatus');
            const statusText = document.getElementById('statusText');
            if (statusDiv && statusText) {
                statusText.textContent = text;
                statusDiv.className = 'data-status ' + type;
            }
        }
        
        function updateLastUpdate() {
            const lastUpdateSpan = document.getElementById('lastUpdate');
            if (lastUpdateSpan) {
                const now = new Date();
                lastUpdateSpan.textContent = now.toLocaleString('ja-JP');
            }
        }
        
        async function loadCSVFromURL(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                const text = await response.text();
                return text;
            } catch (error) {
                throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ' + error.message);
            }
        }
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const csvText = XLSX.utils.sheet_to_csv(firstSheet);
                        resolve(csvText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function() {
                    reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        function parsePriceList(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('ä¾¡æ ¼è¡¨ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
            }
            const headers = lines[0].split(',').map(h => h.trim());
            const priceData = {};
            console.log('ä¾¡æ ¼è¡¨ãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
            if (!headers.includes('product') || !headers.includes('price')) {
                throw new Error('ä¾¡æ ¼è¡¨ã«ã¯ "product" ã¨ "price" åˆ—ãŒå¿…è¦ã§ã™');
            }
            const productIndex = headers.indexOf('product');
            const priceIndex = headers.indexOf('price');
            const profitRateIndex = headers.indexOf('profitRate');
            const profitIndex = headers.indexOf('profit');
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 2) continue;
                const product = values[productIndex].trim();
                const price = parseFloat(values[priceIndex]) || 0;
                if (!product || price === 0) continue;
                priceData[product] = { price: price };
                if (profitRateIndex >= 0 && values[profitRateIndex]) {
                    const profitRateStr = values[profitRateIndex].trim().replace('%', '');
                    priceData[product].profitRate = parseFloat(profitRateStr) || 0;
                }
                if (profitIndex >= 0 && values[profitIndex]) {
                    priceData[product].profit = parseFloat(values[profitIndex]) || 0;
                }
                if (!priceData[product].profit && priceData[product].profitRate) {
                    priceData[product].profit = price * priceData[product].profitRate / 100;
                }
                if (!priceData[product].profitRate && priceData[product].profit && price > 0) {
                    priceData[product].profitRate = (priceData[product].profit / price) * 100;
                }
            }
            console.log('ä¾¡æ ¼è¡¨èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(priceData).length + 'ä»¶');
            return priceData;
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
            }
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            console.log('=== CSVè§£æé–‹å§‹ ===');
            console.log('ãƒ˜ãƒƒãƒ€ãƒ¼æ•°:', headers.length);
            console.log('ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§:', headers);
            const dealColumns = {
                k: [],
                n: [],
                a: [],
                b: [],
                c: [],
                d: []
            };
            headers.forEach((header, index) => {
                const original = header.trim();
                const h = original.toLowerCase().replace(/\s/g, '');
                if (h.match(/[_\-]k$/i) || h.match(/^k[_\-]/i) || h.match(/\d+æœˆ?k$/i) || h.match(/^k\d+$/i)) {
                    dealColumns.k.push(index);
                    console.log('âœ“ Kç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
                else if (h.match(/[_\-]n$/i) || h.match(/^n[_\-]/i) || h.match(/\d+æœˆ?n$/i) || h.match(/^n\d+$/i)) {
                    dealColumns.n.push(index);
                    console.log('âœ“ Nç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
                else if (h.match(/[_\-]a$/i) || h.match(/^a[_\-]/i) || h.match(/\d+æœˆ?a$/i) || h.match(/^a\d+$/i)) {
                    dealColumns.a.push(index);
                    console.log('âœ“ Aç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
                else if (h.match(/[_\-]b$/i) || h.match(/^b[_\-]/i) || h.match(/\d+æœˆ?b$/i) || h.match(/^b\d+$/i)) {
                    dealColumns.b.push(index);
                    console.log('âœ“ Bç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
                else if (h.match(/[_\-]c$/i) || h.match(/^c[_\-]/i) || h.match(/\d+æœˆ?c$/i) || h.match(/^c\d+$/i)) {
                    dealColumns.c.push(index);
                    console.log('âœ“ Cç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
                else if (h.match(/[_\-]d$/i) || h.match(/^d[_\-]/i) || h.match(/\d+æœˆ?d$/i) || h.match(/^d\d+$/i)) {
                    dealColumns.d.push(index);
                    console.log('âœ“ Dç¢ºåº¦åˆ—æ¤œå‡º:', original, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                }
            });
            console.log('=== å•†è«‡åˆ—æ¤œå‡ºçµæœ ===');
            console.log('Kç¢ºåº¦åˆ—æ•°:', dealColumns.k.length, 'åˆ—å:', dealColumns.k.map(i => headers[i]));
            console.log('Nç¢ºåº¦åˆ—æ•°:', dealColumns.n.length, 'åˆ—å:', dealColumns.n.map(i => headers[i]));
            console.log('Aç¢ºåº¦åˆ—æ•°:', dealColumns.a.length, 'åˆ—å:', dealColumns.a.map(i => headers[i]));
            console.log('Bç¢ºåº¦åˆ—æ•°:', dealColumns.b.length, 'åˆ—å:', dealColumns.b.map(i => headers[i]));
            console.log('Cç¢ºåº¦åˆ—æ•°:', dealColumns.c.length, 'åˆ—å:', dealColumns.c.map(i => headers[i]));
            console.log('Dç¢ºåº¦åˆ—æ•°:', dealColumns.d.length, 'åˆ—å:', dealColumns.d.map(i => headers[i]));
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    if (index < values.length) {
                        row[header] = values[index].trim();
                    } else {
                        row[header] = '';
                    }
                });
                row.dept = row.dept || row['å–¶æ¥­éƒ¨'] || row['éƒ¨'] || '';
                row.office = row.office || row['å–¶æ¥­æ‰€'] || row['æ‰€'] || '';
                row.person = row.person || row['å–¶æ¥­å“¡'] || row['æ‹…å½“'] || row['æ°å'] || '';
                row.product = row.product || row['æ©Ÿç¨®'] || row['è£½å“'] || '';
                row.month = row.month || row['æœˆ'] || '';
                row.plan = parseFloat(row.plan || row['è¨ˆç”»å°æ•°'] || row['è¨ˆç”»'] || 0) || 0;
                row.sales = parseFloat(row.sales || row['è²©å£²å°æ•°'] || row['è²©å£²'] || row['å®Ÿç¸¾'] || 0) || 0;
                row.target = parseFloat(row.target || row['ç›®æ¨™å°æ•°'] || row['ç›®æ¨™'] || 0) || 0;
                row.deals_k = 0;
                row.deals_n = 0;
                row.deals_a = 0;
                row.deals_b = 0;
                row.deals_c = 0;
                row.deals_d = 0;
                dealColumns.k.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_k += val;
                    }
                });
                dealColumns.n.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_n += val;
                    }
                });
                dealColumns.a.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_a += val;
                    }
                });
                dealColumns.b.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_b += val;
                    }
                });
                dealColumns.c.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_c += val;
                    }
                });
                dealColumns.d.forEach(colIndex => {
                    const val = parseFloat(values[colIndex]) || 0;
                    if (val > 0) {
                        row.deals_d += val;
                    }
                });
                row.deals = row.deals_k + row.deals_n + row.deals_a + row.deals_b + row.deals_c + row.deals_d;
                if (productMaster[row.product]) {
                    const master = productMaster[row.product];
                    row.planAmount = row.plan * master.price / 1000;
                    row.salesAmount = row.sales * master.price / 1000;
                    row.dealsAmount = row.deals * master.price / 1000;
                    row.targetAmount = row.target * master.price / 1000;
                    row.profitAmount = row.sales * (master.profit || 0) / 1000;
                } else {
                    console.warn('æœªç™»éŒ²ã®æ©Ÿç¨®:', row.product);
                    row.planAmount = 0;
                    row.salesAmount = 0;
                    row.dealsAmount = 0;
                    row.targetAmount = 0;
                    row.profitAmount = 0;
                }
                if (i <= 3) {
                    console.log('è¡Œ' + i + ':', {
                        product: row.product,
                        plan: row.plan,
                        sales: row.sales,
                        deals_k: row.deals_k,
                        deals_n: row.deals_n,
                        deals_a: row.deals_a,
                        deals_b: row.deals_b,
                        deals_c: row.deals_c,
                        deals_d: row.deals_d,
                        deals_total: row.deals,
                        planAmount: row.planAmount.toFixed(2),
                        salesAmount: row.salesAmount.toFixed(2),
                        dealsAmount: row.dealsAmount.toFixed(2)
                    });
                }
                data.push(row);
            }
            console.log('=== ãƒ‘ãƒ¼ã‚¹å®Œäº† ===');
            console.log('ç·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', data.length);
            const totalDeals = data.reduce((sum, item) => sum + (item.deals || 0), 0);
            const totalDealsK = data.reduce((sum, item) => sum + (item.deals_k || 0), 0);
            const totalDealsN = data.reduce((sum, item) => sum + (item.deals_n || 0), 0);
            const totalDealsA = data.reduce((sum, item) => sum + (item.deals_a || 0), 0);
            const totalDealsB = data.reduce((sum, item) => sum + (item.deals_b || 0), 0);
            const totalDealsC = data.reduce((sum, item) => sum + (item.deals_c || 0), 0);
            const totalDealsD = data.reduce((sum, item) => sum + (item.deals_d || 0), 0);
            const totalDealsAmount = data.reduce((sum, item) => sum + (item.dealsAmount || 0), 0);
            const totalPlanAmount = data.reduce((sum, item) => sum + (item.planAmount || 0), 0);
            const totalSalesAmount = data.reduce((sum, item) => sum + (item.salesAmount || 0), 0);
            console.log('=== å…¨ä½“é›†è¨ˆç¢ºèª ===');
            console.log('å•†è«‡ä»¶æ•°åˆè¨ˆ:', totalDeals);
            console.log('  - Kç¢ºåº¦:', totalDealsK);
            console.log('  - Nç¢ºåº¦:', totalDealsN);
            console.log('  - Aç¢ºåº¦:', totalDealsA);
            console.log('  - Bç¢ºåº¦:', totalDealsB);
            console.log('  - Cç¢ºåº¦:', totalDealsC);
            console.log('  - Dç¢ºåº¦:', totalDealsD);
            console.log('å•†è«‡é‡‘é¡åˆè¨ˆ:', totalDealsAmount.toFixed(2), 'ç™¾ä¸‡å††');
            console.log('è¨ˆç”»é‡‘é¡åˆè¨ˆ:', totalPlanAmount.toFixed(2), 'ç™¾ä¸‡å††');
            console.log('è²©å£²é‡‘é¡åˆè¨ˆ:', totalSalesAmount.toFixed(2), 'ç™¾ä¸‡å††');
            return data;
        }
        
        function filterByPeriod(data, period) {
            if (period === 'all') {
                return data;
            }
            const firstHalf = ['4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ'];
            const secondHalf = ['10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'];
            if (period === 'first') {
                return data.filter(item => firstHalf.includes(item.month));
            } else if (period === 'second') {
                return data.filter(item => secondHalf.includes(item.month));
            }
            return data;
        }
        
        function createProgressBar(rate) {
            let className = 'low';
            if (rate >= 80) className = 'excellent';
            else if (rate >= 60) className = 'good';
            else if (rate >= 40) className = 'normal';
            return '<div class="progress-bar-container">' +
                   '<div class="progress-bar-fill ' + className + '" style="width: ' + Math.min(rate, 100) + '%">' +
                   rate + '%' +
                   '</div></div>';
        }
        
        function createCertaintyProgressBar(rate, certaintyKey) {
            return '<div class="progress-bar-container">' +
                   '<div class="progress-bar-fill certainty-' + certaintyKey + '" style="width: ' + Math.min(rate, 100) + '%">' +
                   rate + '%' +
                   '</div></div>';
        }
        
        function createCertaintyBadges(item) {
            let badges = '';
            if (item.deals_k > 0) badges += '<span class="certainty-badge certainty-k">K:' + item.deals_k + '</span>';
            if (item.deals_n > 0) badges += '<span class="certainty-badge certainty-n">N:' + item.deals_n + '</span>';
            if (item.deals_a > 0) badges += '<span class="certainty-badge certainty-a">A:' + item.deals_a + '</span>';
            if (item.deals_b > 0) badges += '<span class="certainty-badge certainty-b">B:' + item.deals_b + '</span>';
            if (item.deals_c > 0) badges += '<span class="certainty-badge certainty-c">C:' + item.deals_c + '</span>';
            if (item.deals_d > 0) badges += '<span class="certainty-badge certainty-d">D:' + item.deals_d + '</span>';
            return badges || '-';
        }
        function aggregateByDept(data) {
            const deptMap = new Map();
            data.forEach(item => {
                if (!deptMap.has(item.dept)) {
                    deptMap.set(item.dept, {
                        dept: item.dept,
                        plan: 0,
                        sales: 0,
                        target: 0,
                        planAmount: 0,
                        salesAmount: 0,
                        targetAmount: 0,
                        profitAmount: 0,
                        deals: 0,
                        dealsAmount: 0,
                        deals_k: 0,
                        deals_n: 0,
                        deals_a: 0,
                        deals_b: 0,
                        deals_c: 0,
                        deals_d: 0
                    });
                }
                const dept = deptMap.get(item.dept);
                dept.plan += item.plan || 0;
                dept.sales += item.sales || 0;
                dept.target += item.target || 0;
                dept.planAmount += item.planAmount || 0;
                dept.salesAmount += item.salesAmount || 0;
                dept.targetAmount += item.targetAmount || 0;
                dept.profitAmount += item.profitAmount || 0;
                dept.deals += item.deals || 0;
                dept.dealsAmount += item.dealsAmount || 0;
                dept.deals_k += item.deals_k || 0;
                dept.deals_n += item.deals_n || 0;
                dept.deals_a += item.deals_a || 0;
                dept.deals_b += item.deals_b || 0;
                dept.deals_c += item.deals_c || 0;
                dept.deals_d += item.deals_d || 0;
            });
            return Array.from(deptMap.values());
        }
        
        function aggregateByOffice(data) {
            const officeMap = new Map();
            data.forEach(item => {
                if (!officeMap.has(item.office)) {
                    officeMap.set(item.office, {
                        dept: item.dept,
                        office: item.office,
                        plan: 0,
                        sales: 0,
                        target: 0,
                        planAmount: 0,
                        salesAmount: 0,
                        targetAmount: 0,
                        profitAmount: 0,
                        deals: 0,
                        dealsAmount: 0,
                        deals_k: 0,
                        deals_n: 0,
                        deals_a: 0,
                        deals_b: 0,
                        deals_c: 0,
                        deals_d: 0
                    });
                }
                const office = officeMap.get(item.office);
                office.plan += item.plan || 0;
                office.sales += item.sales || 0;
                office.target += item.target || 0;
                office.planAmount += item.planAmount || 0;
                office.salesAmount += item.salesAmount || 0;
                office.targetAmount += item.targetAmount || 0;
                office.profitAmount += item.profitAmount || 0;
                office.deals += item.deals || 0;
                office.dealsAmount += item.dealsAmount || 0;
                office.deals_k += item.deals_k || 0;
                office.deals_n += item.deals_n || 0;
                office.deals_a += item.deals_a || 0;
                office.deals_b += item.deals_b || 0;
                office.deals_c += item.deals_c || 0;
                office.deals_d += item.deals_d || 0;
            });
            return Array.from(officeMap.values());
        }
        
        function aggregateByPerson(data) {
            const personMap = new Map();
            data.forEach(item => {
                const key = item.dept + '_' + item.office + '_' + item.person;
                if (!personMap.has(key)) {
                    personMap.set(key, {
                        dept: item.dept,
                        office: item.office,
                        person: item.person,
                        plan: 0,
                        sales: 0,
                        target: 0,
                        planAmount: 0,
                        salesAmount: 0,
                        targetAmount: 0,
                        profitAmount: 0,
                        deals: 0,
                        dealsAmount: 0,
                        deals_k: 0,
                        deals_n: 0,
                        deals_a: 0,
                        deals_b: 0,
                        deals_c: 0,
                        deals_d: 0
                    });
                }
                const person = personMap.get(key);
                person.plan += item.plan || 0;
                person.sales += item.sales || 0;
                person.target += item.target || 0;
                person.planAmount += item.planAmount || 0;
                person.salesAmount += item.salesAmount || 0;
                person.targetAmount += item.targetAmount || 0;
                person.profitAmount += item.profitAmount || 0;
                person.deals += item.deals || 0;
                person.dealsAmount += item.dealsAmount || 0;
                person.deals_k += item.deals_k || 0;
                person.deals_n += item.deals_n || 0;
                person.deals_a += item.deals_a || 0;
                person.deals_b += item.deals_b || 0;
                person.deals_c += item.deals_c || 0;
                person.deals_d += item.deals_d || 0;
            });
            return Array.from(personMap.values());
        }
        
        function aggregateByProduct(data) {
            const productMap = new Map();
            data.forEach(item => {
                if (!productMap.has(item.product)) {
                    productMap.set(item.product, {
                        product: item.product,
                        plan: 0,
                        sales: 0,
                        target: 0,
                        planAmount: 0,
                        salesAmount: 0,
                        targetAmount: 0,
                        profitAmount: 0,
                        deals: 0,
                        dealsAmount: 0,
                        deals_k: 0,
                        deals_n: 0,
                        deals_a: 0,
                        deals_b: 0,
                        deals_c: 0,
                        deals_d: 0
                    });
                }
                const product = productMap.get(item.product);
                product.plan += item.plan || 0;
                product.sales += item.sales || 0;
                product.target += item.target || 0;
                product.planAmount += item.planAmount || 0;
                product.salesAmount += item.salesAmount || 0;
                product.targetAmount += item.targetAmount || 0;
                product.profitAmount += item.profitAmount || 0;
                product.deals += item.deals || 0;
                product.dealsAmount += item.dealsAmount || 0;
                product.deals_k += item.deals_k || 0;
                product.deals_n += item.deals_n || 0;
                product.deals_a += item.deals_a || 0;
                product.deals_b += item.deals_b || 0;
                product.deals_c += item.deals_c || 0;
                product.deals_d += item.deals_d || 0;
            });
            return Array.from(productMap.values());
        }
        
        function aggregateByCertainty(data) {
            const certainties = [
                { key: 'k', label: 'K - å¥‘ç´„æ¸ˆã¿', field: 'deals_k' },
                { key: 'n', label: 'N - å†…ç¤ºã‚ã‚Š', field: 'deals_n' },
                { key: 'a', label: 'A - ç¢ºåº¦A', field: 'deals_a' },
                { key: 'b', label: 'B - ç¢ºåº¦B', field: 'deals_b' },
                { key: 'c', label: 'C - ç¢ºåº¦C', field: 'deals_c' },
                { key: 'd', label: 'D - ç¢ºåº¦D', field: 'deals_d' }
            ];
            const result = [];
            certainties.forEach(cert => {
                let totalDeals = 0;
                let totalAmount = 0;
                data.forEach(item => {
                    const deals = item[cert.field] || 0;
                    totalDeals += deals;
                    if (productMaster[item.product]) {
                        totalAmount += deals * productMaster[item.product].price / 1000;
                    }
                });
                result.push({
                    certainty: cert.label,
                    certaintyKey: cert.key,
                    deals: totalDeals,
                    dealsAmount: totalAmount
                });
            });
            return result;
        }
        
        function groupOfficesByDept(officeData) {
            const grouped = new Map();
            officeData.forEach(office => {
                if (!grouped.has(office.dept)) {
                    grouped.set(office.dept, []);
                }
                grouped.get(office.dept).push(office);
            });
            return grouped;
        }
        
        function updateSummary(data) {
            const totalPlan = data.reduce((sum, item) => sum + (item.plan || 0), 0);
            const totalSales = data.reduce((sum, item) => sum + (item.sales || 0), 0);
            const totalPlanAmount = data.reduce((sum, item) => sum + (item.planAmount || 0), 0);
            const totalSalesAmount = data.reduce((sum, item) => sum + (item.salesAmount || 0), 0);
            const totalDeals = data.reduce((sum, item) => sum + (item.deals || 0), 0);
            const totalDealsAmount = data.reduce((sum, item) => sum + (item.dealsAmount || 0), 0);
            const salesRate = totalPlan > 0 ? ((totalSales / totalPlan) * 100).toFixed(1) : 0;
            const salesAmountRate = totalPlanAmount > 0 ? ((totalSalesAmount / totalPlanAmount) * 100).toFixed(1) : 0;
            document.getElementById('totalPlan').textContent = totalPlan.toFixed(0);
            document.getElementById('totalSales').textContent = totalSales.toFixed(0);
            document.getElementById('totalDeals').textContent = totalDeals.toFixed(0);
            document.getElementById('totalPlanAmount').textContent = totalPlanAmount.toFixed(0);
            document.getElementById('totalSalesAmount').textContent = totalSalesAmount.toFixed(0);
            document.getElementById('totalDealsAmount').textContent = totalDealsAmount.toFixed(0);
            document.getElementById('salesRate').textContent = salesRate + '%';
            document.getElementById('salesAmountRate').textContent = salesAmountRate + '%';
        }
        
        function renderTable(view, data) {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            const sectionTitle = document.getElementById('sectionTitle');
            tbody.innerHTML = '';
            let aggregatedData;
            let headers = '';
            let title = '';
            let displayCount = 0;
            if (view === 'dept') {
                aggregatedData = aggregateByDept(data);
                title = 'ğŸ¢ å–¶æ¥­éƒ¨åˆ¥ å°æ•°ãƒ»é‡‘é¡é”æˆç‡';
                headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>è¨ˆç”»å°æ•°<br>(å°)</th><th>ç›®æ¨™å°æ•°<br>(å°)</th><th>è²©å£²å°æ•°<br>(å°)</th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>è¨ˆç”»é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>è²©å£²é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>å•†è«‡ä»¶æ•°<br>(ä»¶)</th><th>å•†è«‡é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th></tr>';
                thead.innerHTML = headers;
                aggregatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    const plan = item.plan || 0;
                    const target = item.target || 0;
                    const sales = item.sales || 0;
                    const planAmount = item.planAmount || 0;
                    const salesAmount = item.salesAmount || 0;
                    const salesRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                    const amountRate = planAmount > 0 ? ((salesAmount / planAmount) * 100).toFixed(1) : 0;
                    row.innerHTML = '<td><strong>' + item.dept + '</strong></td>' +
                                  '<td>' + plan.toFixed(0) + '</td>' +
                                  '<td>' + target.toFixed(0) + '</td>' +
                                  '<td><strong>' + sales.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(salesRate) + '</td>' +
                                  '<td class="amount">' + planAmount.toFixed(0) + '</td>' +
                                  '<td class="amount"><strong>' + salesAmount.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(amountRate) + '</td>' +
                                  '<td><strong>' + (item.deals || 0).toFixed(0) + '</strong></td>' +
                                  '<td class="amount">' + (item.dealsAmount || 0).toFixed(0) + '</td>';
                    tbody.appendChild(row);
                });
                displayCount = aggregatedData.length;
            } else if (view === 'office') {
                aggregatedData = aggregateByOffice(data);
                const groupedByDept = groupOfficesByDept(aggregatedData);
                title = 'ğŸª å–¶æ¥­æ‰€åˆ¥ å°æ•°ãƒ»é‡‘é¡é”æˆç‡ï¼ˆå–¶æ¥­éƒ¨é›†è¨ˆä»˜ãï¼‰';
                headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>å–¶æ¥­æ‰€</th><th>è¨ˆç”»å°æ•°<br>(å°)</th><th>ç›®æ¨™å°æ•°<br>(å°)</th><th>è²©å£²å°æ•°<br>(å°)</th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>è¨ˆç”»é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>è²©å£²é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th class="col-progress">è¨ˆç”»é”æˆç‡</th></tr>';
                thead.innerHTML = headers;
                groupedByDept.forEach((offices, deptName) => {
                    const deptTotal = { plan: 0, target: 0, sales: 0, planAmount: 0, salesAmount: 0 };
                    offices.forEach(office => {
                        deptTotal.plan += office.plan || 0;
                        deptTotal.target += office.target || 0;
                        deptTotal.sales += office.sales || 0;
                        deptTotal.planAmount += office.planAmount || 0;
                        deptTotal.salesAmount += office.salesAmount || 0;
                    });
                    const deptSalesRate = deptTotal.plan > 0 ? ((deptTotal.sales / deptTotal.plan) * 100).toFixed(1) : 0;
                    const deptAmountRate = deptTotal.planAmount > 0 ? ((deptTotal.salesAmount / deptTotal.planAmount) * 100).toFixed(1) : 0;
                    const deptRow = document.createElement('tr');
                    deptRow.className = 'dept-summary-row';
                    deptRow.innerHTML = '<td colspan="2"><strong>ğŸ“Š ' + deptName + ' åˆè¨ˆ</strong></td>' +
                                      '<td><strong>' + deptTotal.plan.toFixed(0) + '</strong></td>' +
                                      '<td><strong>' + deptTotal.target.toFixed(0) + '</strong></td>' +
                                      '<td><strong>' + deptTotal.sales.toFixed(0) + '</strong></td>' +
                                      '<td>' + createProgressBar(deptSalesRate) + '</td>' +
                                      '<td class="amount"><strong>' + deptTotal.planAmount.toFixed(0) + '</strong></td>' +
                                      '<td class="amount"><strong>' + deptTotal.salesAmount.toFixed(0) + '</strong></td>' +
                                      '<td>' + createProgressBar(deptAmountRate) + '</td>';
                    tbody.appendChild(deptRow);
                    offices.forEach(office => {
                        const row = document.createElement('tr');
                        const plan = office.plan || 0;
                        const target = office.target || 0;
                        const sales = office.sales || 0;
                        const planAmount = office.planAmount || 0;
                        const salesAmount = office.salesAmount || 0;
                        const salesRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                        const amountRate = planAmount > 0 ? ((salesAmount / planAmount) * 100).toFixed(1) : 0;
                        row.innerHTML = '<td>' + office.dept + '</td>' +
                                      '<td><strong>' + office.office + '</strong></td>' +
                                      '<td>' + plan.toFixed(0) + '</td>' +
                                      '<td>' + target.toFixed(0) + '</td>' +
                                      '<td><strong>' + sales.toFixed(0) + '</strong></td>' +
                                      '<td>' + createProgressBar(salesRate) + '</td>' +
                                      '<td class="amount">' + planAmount.toFixed(0) + '</td>' +
                                      '<td class="amount"><strong>' + salesAmount.toFixed(0) + '</strong></td>' +
                                      '<td>' + createProgressBar(amountRate) + '</td>';
                        tbody.appendChild(row);
                        displayCount++;
                    });
                });
            } else if (view === 'person') {
                aggregatedData = aggregateByPerson(data);
                title = 'ğŸ‘¤ å€‹äººåˆ¥ å°æ•°ãƒ»é‡‘é¡é”æˆç‡';
                headers = '<tr><th>å–¶æ¥­éƒ¨</th><th>å–¶æ¥­æ‰€</th><th>å–¶æ¥­å“¡</th><th>è¨ˆç”»å°æ•°<br>(å°)</th><th>ç›®æ¨™å°æ•°<br>(å°)</th><th>è²©å£²å°æ•°<br>(å°)</th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>è¨ˆç”»é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>è²©å£²é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th class="col-progress">è¨ˆç”»é”æˆç‡</th></tr>';
                thead.innerHTML = headers;
                aggregatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    const plan = item.plan || 0;
                    const target = item.target || 0;
                    const sales = item.sales || 0;
                    const planAmount = item.planAmount || 0;
                    const salesAmount = item.salesAmount || 0;
                    const salesRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                    const amountRate = planAmount > 0 ? ((salesAmount / planAmount) * 100).toFixed(1) : 0;
                    row.innerHTML = '<td>' + item.dept + '</td>' +
                                  '<td>' + item.office + '</td>' +
                                  '<td><strong>' + item.person + '</strong></td>' +
                                  '<td>' + plan.toFixed(0) + '</td>' +
                                  '<td>' + target.toFixed(0) + '</td>' +
                                  '<td><strong>' + sales.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(salesRate) + '</td>' +
                                  '<td class="amount">' + planAmount.toFixed(0) + '</td>' +
                                  '<td class="amount"><strong>' + salesAmount.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(amountRate) + '</td>';
                    tbody.appendChild(row);
                });
                displayCount = aggregatedData.length;
            } else if (view === 'product') {
                aggregatedData = aggregateByProduct(data);
                title = 'ğŸ“¦ æ©Ÿç¨®åˆ¥ å°æ•°ãƒ»é‡‘é¡é”æˆç‡';
                headers = '<tr><th class="col-product">æ©Ÿç¨®</th><th>è¨ˆç”»å°æ•°<br>(å°)</th><th>ç›®æ¨™å°æ•°<br>(å°)</th><th>è²©å£²å°æ•°<br>(å°)</th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>è¨ˆç”»é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>è²©å£²é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th class="col-progress">è¨ˆç”»é”æˆç‡</th>' +
                         '<th>å•†è«‡ä»¶æ•°<br>(ä»¶)</th><th>ç¢ºåº¦å†…è¨³</th></tr>';
                thead.innerHTML = headers;
                aggregatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    const plan = item.plan || 0;
                    const target = item.target || 0;
                    const sales = item.sales || 0;
                    const planAmount = item.planAmount || 0;
                    const salesAmount = item.salesAmount || 0;
                    const salesRate = plan > 0 ? ((sales / plan) * 100).toFixed(1) : 0;
                    const amountRate = planAmount > 0 ? ((salesAmount / planAmount) * 100).toFixed(1) : 0;
                    row.innerHTML = '<td class="col-product"><strong>' + item.product + '</strong></td>' +
                                  '<td>' + plan.toFixed(0) + '</td>' +
                                  '<td>' + target.toFixed(0) + '</td>' +
                                  '<td><strong>' + sales.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(salesRate) + '</td>' +
                                  '<td class="amount">' + planAmount.toFixed(0) + '</td>' +
                                  '<td class="amount"><strong>' + salesAmount.toFixed(0) + '</strong></td>' +
                                  '<td>' + createProgressBar(amountRate) + '</td>' +
                                  '<td><strong>' + (item.deals || 0).toFixed(0) + '</strong></td>' +
                                  '<td>' + createCertaintyBadges(item) + '</td>';
                    tbody.appendChild(row);
                });
                displayCount = aggregatedData.length;
            } else if (view === 'certainty') {
                aggregatedData = aggregateByCertainty(data);
                title = 'ğŸ¯ ç¢ºåº¦åˆ¥ å•†è«‡çŠ¶æ³ï¼ˆKãƒ»NãŒå¤šã„ã»ã©è‰¯å¥½ï¼‰';
                headers = '<tr><th>ç¢ºåº¦</th><th>å•†è«‡ä»¶æ•°<br>(ä»¶)</th><th>å•†è«‡é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>æ§‹æˆæ¯”</th></tr>';
                thead.innerHTML = headers;
                const totalDeals = aggregatedData.reduce((sum, item) => sum + item.deals, 0);
                aggregatedData.forEach((item) => {
                    const row = document.createElement('tr');
                    const ratio = totalDeals > 0 ? ((item.deals / totalDeals) * 100).toFixed(1) : 0;
                    row.innerHTML = '<td><strong>' + item.certainty + '</strong></td>' +
                                  '<td><strong>' + item.deals.toFixed(0) + '</strong></td>' +
                                  '<td class="amount"><strong>' + item.dealsAmount.toFixed(0) + '</strong></td>' +
                                  '<td>' + createCertaintyProgressBar(ratio, item.certaintyKey) + '</td>';
                    tbody.appendChild(row);
                });
                displayCount = aggregatedData.length;
            } else if (view === 'amount') {
                aggregatedData = aggregateByOffice(data);
                aggregatedData.sort((a, b) => (b.salesAmount || 0) - (a.salesAmount || 0));
                title = 'ğŸ’° é‡‘é¡åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå–¶æ¥­æ‰€åˆ¥ï¼‰';
                headers = '<tr><th>é †ä½</th><th>å–¶æ¥­æ‰€</th><th>è²©å£²é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th><th>è¨ˆç”»é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th>' +
                         '<th class="col-progress">è¨ˆç”»é”æˆç‡</th><th>è²©å£²å°æ•°<br>(å°)</th><th>å•†è«‡é‡‘é¡<br>(ç™¾ä¸‡å††)<small>è¨ˆç®—å€¤</small></th></tr>';
                thead.innerHTML = headers;
                aggregatedData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const plan = item.plan || 0;
                    const sales = item.sales || 0;
                    const planAmount = item.planAmount || 0;
                    const salesAmount = item.salesAmount || 0;
                    const amountRate = planAmount > 0 ? ((salesAmount / planAmount) * 100).toFixed(1) : 0;
                    row.innerHTML = '<td><strong>' + (index + 1) + 'ä½</strong></td>' +
                                  '<td><strong>' + item.office + '</strong></td>' +
                                  '<td class="amount"><strong>' + salesAmount.toFixed(0) + '</strong></td>' +
                                  '<td class="amount">' + planAmount.toFixed(0) + '</td>' +
                                  '<td>' + createProgressBar(amountRate) + '</td>' +
                                  '<td>' + sales.toFixed(0) + '</td>' +
                                  '<td class="amount">' + (item.dealsAmount || 0).toFixed(0) + '</td>';
                    tbody.appendChild(row);
                });
                displayCount = aggregatedData.length;
            }
            sectionTitle.textContent = title;
            document.getElementById('displayCount').textContent = displayCount;
        }
        
        function initFilters() {
            const depts = [...new Set(allData.map(d => d.dept))].sort();
            const offices = [...new Set(allData.map(d => d.office))].sort();
            const persons = [...new Set(allData.map(d => d.person))].sort();
            const products = [...new Set(allData.map(d => d.product))].sort();
            const deptFilter = document.getElementById('deptFilter');
            const officeFilter = document.getElementById('officeFilter');
            const personFilter = document.getElementById('personFilter');
            const productFilter = document.getElementById('productFilter');
            deptFilter.innerHTML = '<option value="">å…¨å–¶æ¥­éƒ¨</option>';
            depts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
            officeFilter.innerHTML = '<option value="">å…¨å–¶æ¥­æ‰€</option>';
            offices.forEach(office => {
                const option = document.createElement('option');
                option.value = office;
                option.textContent = office;
                officeFilter.appendChild(option);
            });
            personFilter.innerHTML = '<option value="">å…¨å–¶æ¥­å“¡</option>';
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                personFilter.appendChild(option);
            });
            productFilter.innerHTML = '<option value="">å…¨æ©Ÿç¨®</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
        }
        
        function applyFilters() {
            const deptValue = document.getElementById('deptFilter').value;
            const officeValue = document.getElementById('officeFilter').value;
            const personValue = document.getElementById('personFilter').value;
            const productValue = document.getElementById('productFilter').value;
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(item => {
                if (deptValue && item.dept !== deptValue) return false;
                if (officeValue && item.office !== officeValue) return false;
                if (personValue && item.person !== personValue) return false;
                if (productValue && item.product !== productValue) return false;
                if (searchValue) {
                    const searchText = (item.dept + ' ' + item.office + ' ' + item.person + ' ' + item.product).toLowerCase();
                    if (!searchText.includes(searchValue)) return false;
                }
                return true;
            });
            updateDisplay();
        }
        
        function resetFilters() {
            document.getElementById('deptFilter').value = '';
            document.getElementById('officeFilter').value = '';
            document.getElementById('personFilter').value = '';
            document.getElementById('productFilter').value = '';
            document.getElementById('searchInput').value = '';
            filteredData = [...allData];
            updateDisplay();
        }
        
        function updateDisplay() {
            showLoading(true);
            try {
                const periodData = filterByPeriod(filteredData, currentPeriod);
                updateSummary(periodData);
                renderTable(currentView, periodData);
                document.getElementById('dataCount').textContent = allData.length;
            } catch (error) {
                console.error('è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                setTimeout(() => showLoading(false), 100);
            }
        }
        
        async function loadDataFromFiles() {
            try {
                showLoading(true);
                updateStatus('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'loading');
                let salesCsvText;
                try {
                    salesCsvText = await loadCSVFromURL('sales_data.csv');
                    console.log('sales_data.csv ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch (error) {
                    console.warn('sales_data.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', error.message);
                    throw new Error('sales_data.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                }
                try {
                    const priceCsvText = await loadCSVFromURL('price_list.csv');
                    const priceData = parsePriceList(priceCsvText);
                    productMaster = priceData;
                    priceListLoaded = true;
                    console.log('price_list.csv ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch (error) {
                    console.warn('price_list.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾¡æ ¼ã‚’ä½¿ç”¨ï¼‰:', error.message);
                }
                const data = parseCSV(salesCsvText);
                if (data && data.length > 0) {
                                        allData = data;
                    filteredData = [...allData];
                    initFilters();
                    updateDisplay();
                    updateLastUpdate();
                    updateStatus('ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + data.length + 'ä»¶ï¼‰', 'success');
                    return true;
                } else {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(error.message, 'error');
                return false;
            } finally {
                showLoading(false);
            }
        }
        
        async function reloadData() {
            await loadDataFromFiles();
        }
        
        document.getElementById('csvFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            try {
                showLoading(true);
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'loading');
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹:', file.name);
                const csvText = await readFile(file);
                const data = parseCSV(csvText);
                if (data && data.length > 0) {
                    allData = data;
                    filteredData = [...allData];
                    initFilters();
                    updateDisplay();
                    updateLastUpdate();
                    updateStatus('è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + data.length + 'ä»¶ï¼‰', 'success');
                    if (!priceListLoaded) {
                        console.info('ä¾¡æ ¼è¡¨ã‚‚èª­ã¿è¾¼ã‚€ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªé‡‘é¡è¨ˆç®—ãŒã§ãã¾ã™ã€‚');
                    }
                } else {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
            e.target.value = '';
        });
        
        document.getElementById('priceFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            try {
                showLoading(true);
                updateStatus('ä¾¡æ ¼è¡¨ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'loading');
                console.log('ä¾¡æ ¼è¡¨èª­ã¿è¾¼ã¿é–‹å§‹:', file.name);
                const csvText = await readFile(file);
                const priceData = parsePriceList(csvText);
                if (priceData && Object.keys(priceData).length > 0) {
                    productMaster = priceData;
                    priceListLoaded = true;
                    if (allData.length > 0) {
                        allData.forEach(item => {
                            if (productMaster[item.product]) {
                                const master = productMaster[item.product];
                                item.planAmount = item.plan * master.price / 1000;
                                item.salesAmount = item.sales * master.price / 1000;
                                item.dealsAmount = item.deals * master.price / 1000;
                                item.targetAmount = item.target * master.price / 1000;
                                item.profitAmount = item.sales * (master.profit || 0) / 1000;
                            }
                        });
                        filteredData = [...allData];
                        updateDisplay();
                    }
                    updateStatus('ä¾¡æ ¼è¡¨ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ' + Object.keys(priceData).length + 'ä»¶ï¼‰', 'success');
                } else {
                    throw new Error('ä¾¡æ ¼è¡¨ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                }
            } catch (error) {
                console.error('ä¾¡æ ¼è¡¨èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ä¾¡æ ¼è¡¨ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
            e.target.value = '';
        });
        
        document.getElementById('deptFilter').addEventListener('change', applyFilters);
        document.getElementById('officeFilter').addEventListener('change', applyFilters);
        document.getElementById('personFilter').addEventListener('change', applyFilters);
        document.getElementById('productFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.dataset.period;
                if (period) {
                    currentPeriod = period;
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateDisplay();
                }
            });
        });
        
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentView = this.dataset.view;
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const viewNames = {
                    'dept': 'å–¶æ¥­éƒ¨åˆ¥',
                    'office': 'å–¶æ¥­æ‰€åˆ¥',
                    'person': 'å€‹äººåˆ¥',
                    'product': 'æ©Ÿç¨®åˆ¥',
                    'certainty': 'ç¢ºåº¦åˆ¥',
                    'amount': 'é‡‘é¡åˆ¥'
                };
                document.getElementById('viewMode').textContent = viewNames[currentView] || 'å–¶æ¥­æ‰€åˆ¥';
                updateDisplay();
            });
        });
        
        async function initialize() {
            try {
                showLoading(true);
                console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
                updateStatus('åˆæœŸåŒ–ä¸­...', 'loading');
                if (!autoLoadAttempted) {
                    autoLoadAttempted = true;
                    const success = await loadDataFromFiles();
                    if (!success) {
                        updateStatus('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚', 'error');
                        console.info('ğŸ“ ã€Œè²©å£²ãƒ‡ãƒ¼ã‚¿èª­è¾¼ã€ãƒœã‚¿ãƒ³ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    }
                } else {
                    updateStatus('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'info');
                }
                console.log('åˆæœŸåŒ–å®Œäº†');
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾¡æ ¼ãƒã‚¹ã‚¿:', Object.keys(productMaster).length + 'ä»¶');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>